<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rosário · Tradicional</title>
    <style>
        :root {
            --bg-primary: #0a0a0c;
            --bg-secondary: #12121a;
            --text-primary: #e8e6e3;
            --text-secondary: #9a9390;
            --text-muted: #6a645f;
            --accent-gold: #c9a961;
            --accent-gold-dim: #8a7548;
            --accent-gold-bright: #e0c080;
            --bead-ave: #3a3a3a;
            --bead-pater: #c9a961;
            --border-subtle: rgba(255,255,255,0.06);

            --bead-size-ave: 15px;
            --bead-size-pater: 26px;
            --bead-gap: 42px;

            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            font-family: 'Georgia', 'Palatino Linotype', 'Book Antiqua', serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ==================== CABEÇALHO ==================== */
        header {
            text-align: center;
            padding: 24px 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.25em;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-primary);
            position: relative;
            z-index: 10;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 1px;
            background: var(--accent-gold-dim);
        }

        /* ==================== CONTAINER PRINCIPAL ==================== */
        #app {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s var(--transition-smooth);
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* ==================== TELA INICIAL ==================== */
        #home-screen {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .home-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            letter-spacing: 0.15em;
            margin-bottom: 3.5rem;
            text-align: center;
            font-style: italic;
        }

        .home-menu {
            display: flex;
            flex-direction: column;
            gap: 18px;
            width: 100%;
            max-width: 340px;
        }

        .btn-mystery {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 18px 0;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.4s var(--transition-smooth);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            position: relative;
            overflow: hidden;
        }

        .btn-mystery::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(201,169,97,0.1), transparent);
            transition: left 0.6s;
        }

        .btn-mystery:hover::before {
            left: 100%;
        }

        .btn-mystery:hover {
            border-color: var(--accent-gold-dim);
            color: var(--accent-gold);
            background: rgba(201,169,97,0.05);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .btn-mystery:active {
            transform: translateY(0);
        }

        /* ==================== TELA DE ORAÇÃO ==================== */
        #prayer-screen {
            flex-direction: row;
            align-items: stretch;
        }

        .back-btn {
            position: absolute;
            top: 28px;
            left: 28px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            z-index: 30;
            padding: 8px 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn::before {
            content: '←';
            font-size: 1.2rem;
        }

        .back-btn:hover {
            color: var(--accent-gold);
            transform: translateX(-3px);
        }

        .prayer-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 80px 60px 60px;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
        }

        .prayer-info {
            font-size: 0.75rem;
            color: var(--accent-gold-dim);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-weight: 500;
        }

        .prayer-title {
            font-size: 2.2rem;
            font-weight: 300;
            margin-bottom: 10px;
            line-height: 1.3;
            color: var(--text-primary);
            text-align: center;
            letter-spacing: 0.02em;
        }

        .mystery-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-style: italic;
            text-align: center;
        }

        /* --- ESTILO DA IMAGEM --- */
        .sacred-art-container {
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s ease;
            min-height: 220px;
            justify-content: center;
        }

        .sacred-art {
            height: 200px;
            width: auto;
            object-fit: contain;
            border: 2px solid var(--accent-gold-dim);
            box-shadow: 0 0 25px rgba(201,169,97,0.35);
            border-radius: 4px;
            background: #0a0a0c;
            transition: opacity 0.25s ease;
        }

        .art-credit {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 8px;
            font-style: italic;
            text-align: center;
            max-width: 90%;
            opacity: 0.8;
        }

        .meditation-box {
            font-size: 1.15rem;
            line-height: 1.6;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-subtle);
            text-align: center;
            max-width: 560px;
            transition: opacity 0.3s ease;
        }

        .progress-indicator {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 0.1em;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* ==================== ROSÁRIO LATERAL ==================== */
        .rosary-container {
            width: 140px;
            height: 100%;
            position: relative;
            background: linear-gradient(to left, rgba(0,0,0,0.25), transparent);
            overflow: hidden;
            flex-shrink: 0;
            border-left: 1px solid var(--border-subtle);
        }

        .rosary-container::before {
            content: '';
            position: absolute;
            left: 0;
            width: 100%;
            height: 180px;
            top: 0;
            z-index: 10;
            pointer-events: none;
            background: linear-gradient(to bottom, var(--bg-primary) 0%, rgba(10,10,12,0.9) 30%, transparent 100%);
        }

        .rosary-container::after {
            content: '';
            position: absolute;
            left: 0;
            width: 100%;
            height: 180px;
            bottom: 0;
            z-index: 10;
            pointer-events: none;
            background: linear-gradient(to top, var(--bg-primary) 0%, rgba(10,10,12,0.9) 30%, transparent 100%);
        }

        .center-guide {
            position: absolute;
            top: 50%;
            left: 20%;
            right: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(201,169,97,0.15) 50%, transparent);
            transform: translateY(-50%);
            z-index: 5;
        }

        .touch-control {
            position: absolute;
            left: 0;
            width: 100%;
            z-index: 20;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .touch-up { top: 0; height: 25%; }
        .touch-down { bottom: 0; height: 35%; }
        .touch-control:hover { background: rgba(255,255,255,0.02); }

        .bead-track {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            transform: translate3d(-50%, 0, 0);
            transition: transform 0.55s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bead {
            border-radius: 50%;
            margin: calc(var(--bead-gap) / 2) 0;
            transition: all 0.4s var(--transition-smooth);
            position: relative;
            flex-shrink: 0;
        }

        .bead.ave {
            width: var(--bead-size-ave);
            height: var(--bead-size-ave);
            background: var(--bead-ave);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .bead.pater {
            width: var(--bead-size-pater);
            height: var(--bead-size-pater);
            background: transparent;
            border: 2.5px solid var(--accent-gold-dim);
            box-shadow: 0 0 12px rgba(201,169,97,0.2);
        }

        .bead.cross, .bead.credo, .bead.gloria, .bead.salve {
            width: 18px;
            height: 26px;
            background: transparent;
            border: 1.5px solid var(--accent-gold-dim);
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(201,169,97,0.15);
        }

        .bead.active { transform: scale(1.35); z-index: 2; }

        .bead.active.ave {
            background: linear-gradient(135deg, #6a6a6a, #505050);
            box-shadow: 0 0 20px rgba(201,169,97,0.4), 0 4px 12px rgba(0,0,0,0.5);
        }

        .bead.active.pater {
            background: var(--bead-pater);
            border-color: var(--accent-gold-bright);
            box-shadow: 0 0 25px rgba(201,169,97,0.6), 0 0 40px rgba(201,169,97,0.3), 0 4px 12px rgba(0,0,0,0.5);
        }

        .bead.active.cross, .bead.active.credo, .bead.active.gloria, .bead.active.salve {
            background: rgba(201,169,97,0.3);
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(201,169,97,0.5);
        }

        @media (max-width: 768px) {
            header { padding: 20px; font-size: 0.75rem; }
            #prayer-screen { flex-direction: column-reverse; }
            .rosary-container {
                width: 100%;
                height: 120px;
                border-left: none;
                border-top: 1px solid var(--border-subtle);
                background: linear-gradient(to top, rgba(0,0,0,0.25), transparent);
            }
            .rosary-container::before {
                left: 0;
                width: 140px;
                height: 100%;
                background: linear-gradient(to right, var(--bg-primary) 0%, transparent 100%);
            }
            .rosary-container::after {
                right: 0;
                left: auto;
                width: 140px;
                height: 100%;
                background: linear-gradient(to left, var(--bg-primary) 0%, transparent 100%);
            }
            .center-guide { top: 50%; left: 20%; right: 20%; width: auto; height: 1px; }
            .bead-track { flex-direction: row; top: 50%; left: 50%; transform: translate3d(0, -50%, 0); }
            .bead { margin: 0 calc(var(--bead-gap) / 2); }
            .touch-control { width: 25%; height: 100%; }
            .touch-up { left: 0; top: 0; }
            .touch-down { right: 0; left: auto; height: 100%; width: 35%; }
            .prayer-content { padding: 40px 30px; justify-content: flex-start; padding-top: 60px; }
            .sacred-art { height: 160px; }
            .prayer-title { font-size: 1.6rem; }
            .mystery-subtitle { font-size: 0.95rem; }
            .meditation-box { font-size: 1rem; }
            .back-btn { top: 24px; left: 24px; }
            .progress-indicator { bottom: 140px; }
        }
    </style>
</head>
<body>

<header>Rosário · Tradicional</header>

<div id="app">
    <div id="home-screen" class="screen active">
        <p class="home-subtitle">Escolha os mistérios para contemplar</p>
        <nav class="home-menu">
            <button class="btn-mystery" onclick="app.startRosary('gozosos')">Mistérios Gozosos</button>
            <button class="btn-mystery" onclick="app.startRosary('dolorosos')">Mistérios Dolorosos</button>
            <button class="btn-mystery" onclick="app.startRosary('gloriosos')">Mistérios Gloriosos</button>
        </nav>
    </div>

    <div id="prayer-screen" class="screen">
        <button class="back-btn" onclick="app.goHome()">Voltar</button>

        <div class="prayer-content">
            <div class="prayer-info" id="prayer-meta">Década 1 · Conta 1</div>
            <h1 class="prayer-title" id="prayer-name">Ave Maria</h1>
            <p class="mystery-subtitle" id="mystery-subtitle"></p>

            <div id="art-container" class="sacred-art-container" style="display: none;">
                <img id="sacred-art-img" class="sacred-art" src="" alt="Arte Sacra">
                <p id="art-credit" class="art-credit"></p>
            </div>

            <div class="meditation-box" id="prayer-meditation">
                "Ave, cheia de graça..."
            </div>
            <div class="progress-indicator" id="progress-indicator">1 / 59</div>
        </div>

        <div class="rosary-container">
            <div class="center-guide"></div>
            <div class="touch-control touch-up" onclick="app.prevBead()"></div>
            <div class="touch-control touch-down" onclick="app.nextBead()"></div>
            <div class="bead-track" id="bead-track"></div>
        </div>
    </div>
</div>

<script>
/* =============================================================
   POR QUE AS IMAGENS NÃO ABRIAM?
   - Você estava usando muitos "thumb URLs" diretos da Wikimedia.
   - Alguns estavam errados/instáveis (404) e "quebram" com hash/tamanho.
   CORREÇÃO:
   - Guardar só o NOME DO ARQUIVO no Commons e obter o thumb via MediaWiki API.
   - Com cache local e fallback seguro.
   ============================================================= */

// ==================== BANCO DE ARTE (somente nomes de arquivos) ====================
const ART_FILES = {
  gozosos: {
    m1: [
      { file: "Fra_Angelico_-_Annunciation_-_WGA00462.jpg", credit: "Fra Angelico, c. 1430" },
      { file: "Annunciation_Leonardo.jpg", credit: "Leonardo da Vinci, c. 1472" }
    ],
    m2: [
      { file: "Mariotto_Albertinelli_Visitation.jpg", credit: "Mariotto Albertinelli, 1503" },
      { file: "Pontormo_-_Visitation_-_WGA18086.jpg", credit: "Pontormo, 1528" }
    ],
    m3: [
      { file: "Gerard_van_Honthorst_-_Adoration_of_the_Shepherds_(1622).jpg", credit: "Gerard van Honthorst, 1622" },
      { file: "Correggio_-_Adoration_of_the_Shepherds_(The_Holy_Night)_-_Google_Art_Project.jpg", credit: "Correggio, c. 1529" }
    ],
    m4: [
      { file: "Andrea_Mantegna_-_Presentation_at_the_Temple_-_WGA13978.jpg", credit: "Andrea Mantegna, c. 1455" },
      { file: "Rembrandt_Harmensz._van_Rijn_096.jpg", credit: "Rembrandt, 1631" }
    ],
    m5: [
      { file: "Albrecht_D%C3%BCrer_-_Christ_among_the_Doctors_-_Google_Art_Project.jpg", credit: "Albrecht Dürer, 1506" },
      { file: "Paolo_Veronese_012.jpg", credit: "Paolo Veronese, 1548" }
    ]
  },
  dolorosos: {
    m1: [
      { file: "El_Greco_-_The_Agony_in_the_Garden_-_WGA10526.jpg", credit: "El Greco" },
      { file: "Giovanni_Bellini_-_Agony_in_the_Garden_-_National_Gallery%2C_London.jpg", credit: "Bellini" }
    ],
    m2: [
      { file: "Caravaggio_-_The_Flagellation_of_Christ_-_WGA04153.jpg", credit: "Caravaggio" }
    ],
    m3: [
      { file: "Tizian_078.jpg", credit: "Ticiano" }
    ],
    m4: [
      { file: "El_Greco_-_Christ_Carrying_the_Cross_-_WGA10471.jpg", credit: "El Greco" }
    ],
    m5: [
      { file: "Cristo_crucificado.jpg", credit: "Velázquez" }
    ]
  },
  gloriosos: {
    m1: [
      { file: "Piero_della_Francesca_046.jpg", credit: "Piero della Francesca" }
    ],
    // Corrigido: o seu banco original usava WGA09228, que frequentemente dá 404.
    // Este nome é o mais comum para a cena "Ascension" do ciclo WGA do Giotto.
    m2: [
      { file: "Giotto_di_Bondone_-_No._38_Scenes_from_the_Life_of_Christ_-_22._Ascension_-_WGA09226.jpg", credit: "Giotto" }
    ],
    m3: [
      { file: "El_Greco_-_The_Pentecost_-_WGA10555.jpg", credit: "El Greco" }
    ],
    m4: [
      { file: "Tizian_-_Assunta_-_Frari_Venedig.jpg", credit: "Ticiano" }
    ],
    m5: [
      { file: "Coronaci%C3%B3n_de_la_Virgen_(Vel%C3%A1zquez).jpg", credit: "Velázquez" }
    ]
  }
};

// ==================== RESOLVER THUMBS VIA MEDIAWIKI API (COM CACHE) ====================
const COMMONS_THUMB_WIDTH = 640;
const FALLBACK_IMG = "https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/Hofmann_Getsemani.jpg/400px-Hofmann_Getsemani.jpg";
const artCache = new Map();

function cacheKey(file, width) { return `${file}|${width}`; }

function safeDecode(s) {
  try { return decodeURIComponent(s); } catch (_) { return s; }
}

function loadCacheFromStorage() {
  try {
    const raw = localStorage.getItem("rosary_art_cache_v1");
    if (!raw) return;
    const obj = JSON.parse(raw);
    for (const [k, v] of Object.entries(obj)) artCache.set(k, v);
  } catch (_) {}
}

function saveCacheToStorage() {
  try {
    const obj = Object.fromEntries(artCache.entries());
    localStorage.setItem("rosary_art_cache_v1", JSON.stringify(obj));
  } catch (_) {}
}

loadCacheFromStorage();

async function getCommonsThumbUrl(fileRaw, width = COMMONS_THUMB_WIDTH) {
  const file = safeDecode(fileRaw);
  const k = cacheKey(file, width);
  if (artCache.has(k)) return artCache.get(k);

  const title = `File:${file}`;
  const api = "https://commons.wikimedia.org/w/api.php";
  const url =
    `${api}?action=query&titles=${encodeURIComponent(title)}` +
    `&prop=imageinfo&iiprop=url&iiurlwidth=${encodeURIComponent(width)}` +
    `&format=json&origin=*`;

  const res = await fetch(url, { cache: "force-cache" });
  if (!res.ok) throw new Error(`API error ${res.status}`);
  const data = await res.json();

  const pages = data?.query?.pages;
  const firstPage = pages ? pages[Object.keys(pages)[0]] : null;
  const thumb = firstPage?.imageinfo?.[0]?.thumburl || firstPage?.imageinfo?.[0]?.url;
  if (!thumb) throw new Error("No thumburl");

  artCache.set(k, thumb);
  saveCacheToStorage();
  return thumb;
}

// ==================== DADOS ESPIRITUAIS (MONTFORT) ====================
const MYSTERIES = {
  gozosos: [
    { id: 'm1', title: "A Anunciação", intro: "Oferecemos-Vos, Senhor Jesus, esta primeira dezena em honra da Encarnação...", beads: [
      "1. A Santíssima Trindade decreta a Encarnação do Verbo.", "2. O Anjo Gabriel desce à terra para saudar Maria.", "3. A saudação angélica: Ave, cheia de graça.", "4. A perturbação de Maria e sua virgindade.", "5. A explicação do Anjo sobre a obra do Espírito Santo.", "6. O consentimento de Maria: Eis a escrava do Senhor.", "7. O Verbo se faz carne no seio de Maria.", "8. A adoração dos anjos ao Verbo Encarnado.", "9. A alegria de Deus ao contemplar seu Filho homem.", "10. A humildade profunda de Jesus e Maria." ] },
    { id: 'm2', title: "A Visitação", intro: "Oferecemos-Vos, Senhor Jesus, esta segunda dezena em honra da Visitação...", beads: [
      "1. A alegria de Maria ao saber da gravidez de Isabel.", "2. Maria apressa-se para ir às montanhas.", "3. O encontro e a saudação de Maria a Isabel.", "4. A santificação de São João Batista no ventre.", "5. Isabel cheia do Espírito Santo exclama.", "6. Bendita és tu entre as mulheres.", "7. Bendito é o fruto do teu ventre, Jesus.", "8. O cântico do Magnificat de Maria.", "9. A caridade de Maria servindo sua prima.", "10. A gratidão a Deus pelos seus dons." ] },
    { id: 'm3', title: "O Nascimento", intro: "Oferecemos-Vos, Senhor Jesus, esta terceira dezena em honra do Nascimento...", beads: [
      "1. O decreto de César e a viagem a Belém.", "2. A rejeição nas estalagens de Belém.", "3. O refúgio na gruta pobre e fria.", "4. O nascimento virginal do Salvador.", "5. Maria envolve Jesus em faixas na manjedoura.", "6. O canto de glória e paz dos anjos.", "7. A adoração dos pastores humildes.", "8. A circuncisão e o nome de Jesus.", "9. A adoração dos Reis Magos e seus presentes.", "10. A pobreza e o desprezo do mundo." ] },
    { id: 'm4', title: "A Apresentação", intro: "Oferecemos-Vos, Senhor Jesus, esta quarta dezena em honra da Apresentação...", beads: [
      "1. A obediência de Maria à Lei de Moisés.", "2. A oferta de Jesus ao Pai no Templo.", "3. O resgate do Criador por duas rolas.", "4. A profecia de Simeão sobre a salvação.", "5. A profecia de Simeão sobre a espada de dor.", "6. O encontro com a profetisa Ana.", "7. O crescimento de Jesus em sabedoria e graça.", "8. A pureza de corpo e de espírito.", "9. A obediência à vontade de Deus.", "10. O sacrifício dos nossos corações." ] },
    { id: 'm5', title: "Perda e Encontro", intro: "Oferecemos-Vos, Senhor Jesus, esta quinta dezena em honra do Encontro...", beads: [
      "1. Jesus aos doze anos sobe a Jerusalém.", "2. Jesus fica no Templo sem os pais saberem.", "3. A dor de Maria e José ao notarem a falta.", "4. A busca angustiosa por três dias.", "5. O encontro entre os doutores da Lei.", "6. A sabedoria divina nas respostas de Jesus.", "7. A pergunta de Maria: Por que fizeste isso?", "8. A resposta: Devo tratar das coisas de meu Pai.", "9. A submissão de Jesus em Nazaré.", "10. A busca constante pela presença de Deus." ] }
  ],
  dolorosos: [
    { id: 'm1', title: "A Agonia no Horto", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da Agonia...", beads: [
      "1. Jesus retira-se ao Jardim das Oliveiras.", "2. A tristeza mortal da alma de Cristo.", "3. A visão de todos os pecados do mundo.", "4. A visão dos sofrimentos futuros.", "5. O suor de sangue caindo por terra.", "6. A oração humilde: Afasta de mim este cálice.", "7. A conformidade: Não a minha vontade, mas a vossa.", "8. O anjo que o conforta.", "9. O sono dos apóstolos e a repreensão.", "10. O beijo de Judas e a traição." ] },
    { id: 'm2', title: "A Flagelação", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da Flagelação...", beads: [
      "1. Jesus é levado de tribunal em tribunal.", "2. As acusações falsas e o silêncio de Jesus.", "3. Pilatos declara a inocência mas o condena.", "4. Jesus é despido brutalmente.", "5. Amarrado à coluna da ignomínia.", "6. Os golpes cruéis dos açoites.", "7. A carne rasgada e o sangue precioso.", "8. A mansidão do Cordeiro de Deus.", "9. A expiação pelos pecados da carne.", "10. A necessidade de mortificar nossos sentidos." ] },
    { id: 'm3', title: "Coroação de Espinhos", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da Coroação...", beads: [
      "1. Os soldados levam Jesus ao pretório.", "2. Vestem-no com um manto de púrpura.", "3. Tecem uma coroa de espinhos agudos.", "4. Cravam a coroa em sua cabeça sagrada.", "5. Colocam uma cana como cetro em sua mão.", "6. As zombarias: Salve, Rei dos Judeus.", "7. As cusparadas e bofetadas na face.", "8. Pilatos apresenta-o: Ecce Homo.", "9. A expiação pelos pecados de orgulho.", "10. O reinado de Cristo em nossos corações." ] },
    { id: 'm4', title: "O Caminho da Cruz", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra do Caminho da Cruz...", beads: [
      "1. A condenação à morte de cruz.", "2. Jesus carrega o madeiro pesado.", "3. O encontro doloroso com sua Mãe.", "4. As quedas de Jesus sob o peso da cruz.", "5. Simão Cirineu é forçado a ajudar.", "6. A Verônica enxuga o rosto de Jesus.", "7. As mulheres de Jerusalém choram.", "8. O despojamento das vestes no Calvário.", "9. O fel e o vinagre oferecidos.", "10. A paciência nas nossas próprias cruzes." ] },
    { id: 'm5', title: "A Crucifixão", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da vossa Morte...", beads: [
      "1. Jesus é pregado na cruz com cravos.", "2. A cruz é erguida entre dois ladrões.", "3. A oração pelos algozes: Pai, perdoa-lhes.", "4. A promessa ao bom ladrão.", "5. A entrega de Maria a João: Eis a tua mãe.", "6. O abandono e a sede: Tenho sede.", "7. Tudo está consumado.", "8. A entrega do espírito nas mãos do Pai.", "9. O lado aberto pela lança.", "10. O sacrifício perfeito pela nossa salvação." ] }
  ],
  gloriosos: [
    { id: 'm1', title: "A Ressurreição", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da Ressurreição...", beads: [
      "1. A alma de Jesus desce aos infernos.", "2. O corpo glorioso se une à alma no sepulcro.", "3. A vitória sobre a morte e o pecado.", "4. A aparição resplandecente à sua Mãe.", "5. A aparição a Madalena e às santas mulheres.", "6. A aparição aos apóstolos no Cenáculo.", "7. A dúvida e a confissão de Tomé.", "8. A confirmação da fé dos discípulos.", "9. O poder da nossa própria ressurreição.", "10. A fé inabalável na palavra de Deus." ] },
    { id: 'm2', title: "A Ascensão", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da Ascensão...", beads: [
      "1. As últimas instruções aos apóstolos.", "2. A promessa do Espírito Santo.", "3. A subida ao Monte das Oliveiras.", "4. A benção final aos discípulos.", "5. Jesus eleva-se aos céus pelo próprio poder.", "6. A nuvem que o oculta aos olhos humanos.", "7. A entrada triunfal no Céu.", "8. O assento à direita do Pai.", "9. O desejo do céu e desapego da terra.", "10. A esperança de estarmos com Ele um dia." ] },
    { id: 'm3', title: "Pentecostes", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra de Pentecostes...", beads: [
      "1. A oração unânime com Maria no Cenáculo.", "2. O ruído do céu como vento impetuoso.", "3. As línguas de fogo sobre cada um.", "4. A plenitude do Espírito Santo.", "5. A sabedoria e o entendimento divinos.", "6. O conselho e a fortaleza na fé.", "7. A ciência, piedade e temor de Deus.", "8. A pregação destemida dos apóstolos.", "9. A conversão das multidões.", "10. A renovação da face da terra." ] },
    { id: 'm4', title: "A Assunção", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da Assunção...", beads: [
      "1. O desejo ardente de Maria de ver Deus.", "2. A morte suave por amor divino.", "3. A reunião dos apóstolos junto dela.", "4. A ressurreição do corpo imaculado.", "5. A subida gloriosa aos céus pelos anjos.", "6. O encontro com seu Filho divino.", "7. A alegria de toda a corte celeste.", "8. A exaltação acima de todos os anjos.", "9. A esperança da nossa ressurreição.", "10. A verdadeira devoção à nossa Mãe." ] },
    { id: 'm5', title: "A Coroação", intro: "Oferecemos-Vos, Senhor Jesus, esta dezena em honra da Coroação...", beads: [
      "1. A Santíssima Trindade acolhe Maria.", "2. O Pai coroa sua Filha predileta.", "3. O Filho coroa sua Mãe santíssima.", "4. O Espírito Santo coroa sua Esposa fiel.", "5. Maria Rainha do Céu e da Terra.", "6. A mediadora de todas as graças.", "7. O refúgio dos pecadores.", "8. A alegria dos justos e terror dos demônios.", "9. A perseverança final na graça.", "10. A coroa da glória eterna para nós." ] }
  ]
};

const PRAYERS = {
  cross: { name: "Sinal da Cruz", med: "Em nome do Pai, e do Filho, e do Espírito Santo." },
  credo: { name: "Creio", med: "Creio em Deus Pai Todo-Poderoso..." },
  pater: { name: "Pai Nosso" },
  ave: { name: "Ave Maria", med: "" },
  gloria: { name: "Glória", med: "Glória ao Pai, ao Filho e ao Espírito Santo." },
  fatima: { name: "Ó meu Jesus", med: "Perdoai-nos e livrai-nos do fogo do inferno." },
  salve: { name: "Salve Rainha", med: "Salve, Rainha, Mãe de Misericórdia..." }
};

// ==================== APLICAÇÃO ====================
const app = {
  state: {
    currentMystery: null,
    beads: [],
    currentIndex: 0,
    artReqId: 0
  },

  elements: {
    homeScreen: document.getElementById('home-screen'),
    prayerScreen: document.getElementById('prayer-screen'),
    beadTrack: document.getElementById('bead-track'),
    prayerMeta: document.getElementById('prayer-meta'),
    prayerName: document.getElementById('prayer-name'),
    mysterySubtitle: document.getElementById('mystery-subtitle'),
    prayerMed: document.getElementById('prayer-meditation'),
    progressIndicator: document.getElementById('progress-indicator'),
    artContainer: document.getElementById('art-container'),
    artImg: document.getElementById('sacred-art-img'),
    artCredit: document.getElementById('art-credit')
  },

  init() {
    document.addEventListener('keydown', (e) => {
      if (!this.state.currentMystery) return;
      if (['ArrowDown','ArrowRight',' '].includes(e.key)) { e.preventDefault(); this.nextBead(); }
      if (['ArrowUp','ArrowLeft'].includes(e.key)) { e.preventDefault(); this.prevBead(); }
      if (e.key === 'Escape') this.goHome();
    });

    let wheelTimeout;
    window.addEventListener('wheel', (e) => {
      if (!this.state.currentMystery) return;
      if (!wheelTimeout) {
        if (e.deltaY > 0) this.nextBead();
        else if (e.deltaY < 0) this.prevBead();
        wheelTimeout = setTimeout(() => wheelTimeout = null, 150);
      }
    }, { passive: true });

    let touchStartY = 0;
    document.addEventListener('touchstart', (e) => touchStartY = e.touches[0].clientY, { passive: true });
    document.addEventListener('touchend', (e) => {
      if (!this.state.currentMystery) return;
      const touchEndY = e.changedTouches[0].clientY;
      const diff = touchStartY - touchEndY;
      if (Math.abs(diff) > 50) {
        if (diff > 0) this.nextBead();
        else this.prevBead();
      }
    }, { passive: true });
  },

  // Preload do próximo arquivo para reduzir flicker
  async preloadCommonsThumb(fileRaw) {
    if (!fileRaw) return;
    try {
      const url = await getCommonsThumbUrl(fileRaw, COMMONS_THUMB_WIDTH);
      const img = new Image();
      img.src = url;
    } catch (_) {}
  },

  generateSequence(mysteryKey) {
    const mysteries = MYSTERIES[mysteryKey];
    const artwork = ART_FILES[mysteryKey];
    const seq = [];
    let id = 0;

    const add = (type, prayer, meta = '', med = '', mysteryTitle = '', imgData = null) => {
      seq.push({
        id: id++,
        type,
        name: prayer.name || prayer,
        meta,
        med: med || prayer.med || '',
        mysteryTitle,
        imgData
      });
    };

    add('cross', PRAYERS.cross, 'Início');
    add('credo', PRAYERS.credo, 'Profissão de Fé');
    add('pater', PRAYERS.pater, 'Intenções', 'Pelas intenções do Santo Padre, o Papa.');
    add('ave', PRAYERS.ave, 'Virtudes', 'Pela virtude da Fé.');
    add('ave', PRAYERS.ave, 'Virtudes', 'Pela virtude da Esperança.');
    add('ave', PRAYERS.ave, 'Virtudes', 'Pela virtude da Caridade.');
    add('gloria', PRAYERS.gloria, 'Glória');

    mysteries.forEach((myst, idx) => {
      const num = idx + 1;
      const mystId = myst.id;
      const artArray = (artwork && artwork[mystId]) ? artwork[mystId] : [];

      // Pai Nosso
      add('pater', PRAYERS.pater, `${num}º Mistério`, myst.intro, myst.title, artArray[0] || null);

      // 10 Ave Marias
      for (let i = 0; i < 10; i++) {
        const artIndex = artArray.length ? (i % artArray.length) : 0;
        add('ave', PRAYERS.ave, `${num}ª Dezena · Conta ${i+1}`, myst.beads[i], myst.title, artArray.length ? artArray[artIndex] : null);
      }

      const lastImg = artArray.length ? artArray[artArray.length - 1] : null;
      add('gloria', PRAYERS.gloria, `${num}ª Dezena`, '', myst.title, lastImg);
      add('ave', PRAYERS.fatima, `${num}ª Dezena`, '', myst.title, lastImg);
    });

    add('salve', PRAYERS.salve, 'Encerramento');
    return seq;
  },

  startRosary(mysteryKey) {
    this.state.currentMystery = mysteryKey;
    this.state.beads = this.generateSequence(mysteryKey);
    this.state.currentIndex = 0;

    this.elements.beadTrack.innerHTML = '';
    this.state.beads.forEach((bead, idx) => {
      const el = document.createElement('div');
      el.className = `bead ${bead.type}`;
      if (idx === 0) el.classList.add('active');
      this.elements.beadTrack.appendChild(el);
    });

    this.elements.homeScreen.classList.remove('active');
    this.elements.prayerScreen.classList.add('active');
    this.updateView();
  },

  goHome() {
    this.state.currentMystery = null;
    this.elements.prayerScreen.classList.remove('active');
    this.elements.homeScreen.classList.add('active');
  },

  nextBead() {
    if (this.state.currentIndex < this.state.beads.length - 1) {
      this.state.currentIndex++;
      this.updateView();
    }
  },

  prevBead() {
    if (this.state.currentIndex > 0) {
      this.state.currentIndex--;
      this.updateView();
    }
  },

  async setArt(imgData) {
    const reqId = ++this.state.artReqId;

    this.elements.artContainer.style.display = "flex";
    this.elements.artCredit.textContent = imgData?.credit || "";
    this.elements.artContainer.style.opacity = "1";

    // loading state suave
    this.elements.artImg.style.opacity = "0.85";

    try {
      const url = await getCommonsThumbUrl(imgData.file, COMMONS_THUMB_WIDTH);
      if (reqId !== this.state.artReqId) return;

      this.elements.artImg.onload = () => {
        if (reqId !== this.state.artReqId) return;
        this.elements.artImg.style.opacity = "1";
      };

      this.elements.artImg.onerror = () => {
        if (reqId !== this.state.artReqId) return;
        this.elements.artImg.src = FALLBACK_IMG;
        this.elements.artImg.style.opacity = "1";
      };

      this.elements.artImg.src = url;
    } catch (_) {
      if (reqId !== this.state.artReqId) return;
      this.elements.artImg.src = FALLBACK_IMG;
      this.elements.artImg.style.opacity = "1";
    }
  },

  hideArt() {
    this.elements.artContainer.style.opacity = "0";
    setTimeout(() => {
      if (this.elements.artContainer.style.opacity === "0") {
        this.elements.artContainer.style.display = "none";
      }
    }, 500);
  },

  updateView() {
    const idx = this.state.currentIndex;
    const bead = this.state.beads[idx];
    const track = this.elements.beadTrack;
    const beadEls = track.children;

    // Preload da próxima imagem (se houver)
    if (idx < this.state.beads.length - 1) {
      const nextBead = this.state.beads[idx + 1];
      if (nextBead.imgData?.file) this.preloadCommonsThumb(nextBead.imgData.file);
    }

    // UI Textos
    this.elements.prayerMeta.textContent = bead.meta;
    this.elements.prayerName.textContent = bead.name;
    this.elements.mysterySubtitle.textContent = bead.mysteryTitle || '';
    this.elements.progressIndicator.textContent = `${idx + 1} / ${this.state.beads.length}`;

    // Imagem (agora robusta via API)
    if (bead.imgData?.file) this.setArt(bead.imgData);
    else this.hideArt();

    // Meditação
    const medBox = this.elements.prayerMed;
    medBox.style.opacity = '0';
    setTimeout(() => {
      medBox.textContent = bead.med;
      medBox.style.opacity = '1';
    }, 200);

    // Rosário
    Array.from(beadEls).forEach(el => el.classList.remove('active'));
    beadEls[idx].classList.add('active');

    const activeEl = beadEls[idx];
    const beadCenter = activeEl.offsetTop + (activeEl.offsetHeight / 2);
    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
      const beadCenterX = activeEl.offsetLeft + (activeEl.offsetWidth / 2);
      track.style.transform = `translate3d(-${beadCenterX}px, -50%, 0)`;
    } else {
      track.style.transform = `translate3d(-50%, -${beadCenter}px, 0)`;
    }
  }
};

app.init();
</script>
</body>
</html>
