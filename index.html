<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rosário">
    
    <title>Santo Rosário · Método Montfort</title>
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icon-192.png">
    <link rel="manifest" href="/manifest.json">
    
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icon-192.png">
    
    <meta name="description" content="Reze o Santo Rosário pelo Método de São Luís de Montfort. App completo com meditações, calendário e acompanhamento.">
    <meta name="theme-color" content="#080709">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg-deep: #080709;
            --bg-primary: #0d0b0e;
            --bg-secondary: #151316;
            --bg-elevated: #1d1a1f;
            --bg-card: #1a171c;
            --text-primary: #f4f1eb;
            --text-secondary: #c2b8aa;
            --text-muted: #7d7470;
            --text-dim: #4d4845;
            --gold: #d4a855;
            --gold-bright: #f5d680;
            --gold-light: #e8c45a;
            --gold-dim: #a58540;
            --gold-dark: #6a5225;
            --gold-glow: rgba(212, 168, 85, 0.5);
            --burgundy: #6b2d3d;
            --burgundy-light: #8a3d50;
            --burgundy-bright: #a04d62;
            --burgundy-glow: rgba(138, 61, 80, 0.5);
            --cream: #faf5e8;
            --border-subtle: rgba(212, 168, 85, 0.1);
            --border-gold: rgba(212, 168, 85, 0.25);
            --font-display: 'Cinzel', serif;
            --font-body: 'Cormorant Garamond', serif;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --bead-size: 48px;
            --bead-size-small: 36px;
            --bead-size-pater: 56px;
            --bead-gap: 20px;
            --rail-width: 110px;
        }
        *{ box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent;}
        html, body{ height: 100%; overflow: hidden; background: var(--bg-deep);}
        body{
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 18px;
            line-height: 1.6;
        }
        /* Modal de Confirmação Personalizado */
.custom-alert {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 400;
    animation: fadeIn 0.3s ease-out;
}

.custom-alert.active {
    display: flex;
}

.custom-alert-content {
    background: var(--bg-card);
    border: 1px solid var(--border-gold);
    border-radius: 16px;
    padding: 32px 28px;
    max-width: 340px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    animation: slideUp 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.custom-alert-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    color: var(--gold);
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
}

.custom-alert-title {
    font-family: var(--font-display);
    font-size: 1.2rem;
    letter-spacing: 0.15em;
    color: var(--text-primary);
    margin-bottom: 12px;
}

.custom-alert-message {
    font-family: var(--font-body);
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
}

.custom-alert-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
    border: none;
    border-radius: 8px;
    font-family: var(--font-display);
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--bg-deep);
    cursor: pointer;
    transition: all 0.3s;
}

.custom-alert-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(212, 168, 85, 0.4);
}
/* Modal de Decisão (Sim/Não) */
.custom-confirm-btn-row {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}
.custom-confirm-btn {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    font-family: var(--font-display);
    font-size: 0.8rem;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
}
.btn-yes {
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
    color: var(--bg-deep);
}
.btn-no {
    background: transparent;
    border: 1px solid var(--border-subtle);
    color: var(--text-muted);
}

        /* Textura de fundo refinada */
        body::before{
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 15% 15%, rgba(107, 45, 61, 0.12) 0%, transparent 45%),
                radial-gradient(ellipse at 85% 85%, rgba(212, 168, 85, 0.08) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(20, 18, 22, 0.5) 0%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }
        /* ===== TELA DE AUTENTICAÇÃO ===== */
        #auth-screen{
            position: fixed; inset: 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            padding: 28px;
            padding-top: 60px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 200;
            transition: opacity 0.6s var(--ease-out), visibility 0.6s;
        }
        #auth-screen.hidden{ opacity: 0; visibility: hidden; pointer-events: none;}
        .auth-container{ width: 100%; max-width: 380px; text-align: center;}
        
        /* LOGO DOURADA COM MOLDURA */
        .auth-logo { 
            width: 90px; 
            height: 90px; 
            margin: 0 auto 24px; 
            position: relative; 
            border-radius: 18px;
            border: 2px solid var(--gold);
            box-shadow: 0 0 30px rgba(212, 168, 85, 0.4), inset 0 0 15px rgba(212, 168, 85, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, #2a252e 0%, #080709 100%);
            overflow: hidden;
        }
        .auth-logo img {
            width: 70%;
            height: auto;
            filter: drop-shadow(0 0 8px rgba(212, 168, 85, 0.6));
        }
        
        .auth-title{
            font-family: var(--font-display); font-size: 1.8rem; font-weight: 500;
            letter-spacing: 0.2em; color: var(--text-primary); margin-bottom: 6px;
        }
        .auth-subtitle{
            font-family: var(--font-body); font-size: 1rem; font-style: italic;
            color: var(--text-muted); margin-bottom: 20px;
        }
        .auth-info{
            background: rgba(212, 168, 85, 0.1); border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 16px; margin-bottom: 24px;
            font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;
        }
        /* AVISO DE SEGURANÇA */
        .auth-warning {
            color: #e07070;
            font-size: 0.8rem;
            margin-top: 12px;
            font-style: italic;
            border: 1px solid rgba(180, 60, 60, 0.3);
            padding: 10px;
            border-radius: 6px;
            background: rgba(180, 60, 60, 0.1);
        }

        .auth-tabs{ display: flex; margin-bottom: 28px; border-bottom: 1px solid var(--border-subtle);}
        .auth-tab{
            flex: 1; padding: 14px; background: none; border: none;
            font-family: var(--font-display); font-size: 0.75rem;
            letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--text-muted); cursor: pointer;
            transition: all 0.3s; position: relative;
        }
        .auth-tab::after{
            content: ''; position: absolute; bottom: -1px;
            left: 50%; transform: translateX(-50%); width: 0; height: 2px;
            background: var(--gold); transition: width 0.3s var(--ease-out);
        }
        .auth-tab.active{ color: var(--gold);}
        .auth-tab.active::after{ width: 60%;}
        .auth-form{ display: none;}
        .auth-form.active{ display: block;}
        .input-group{ margin-bottom: 18px; text-align: left;}
        .input-label{
            display: block; font-family: var(--font-display);
            font-size: 0.6rem; letter-spacing: 0.2em;
            text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px;
        }
        .input-field{
            width: 100%; padding: 14px 16px; background: #0f0d10;
            border: 1px solid var(--border-subtle); border-radius: 4px;
            font-family: var(--font-body); font-size: 1.05rem;
            color: var(--text-primary); transition: all 0.3s;
        }
        .input-field:focus{
            outline: none; border-color: var(--gold-dim);
            box-shadow: 0 0 0 3px rgba(212, 168, 85, 0.1);
        }
        .input-field::placeholder{ color: var(--text-dim);}
        .auth-btn{
            width: 100%; padding: 16px; margin-top: 8px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
            border: none; border-radius: 4px;
            font-family: var(--font-display); font-size: 0.85rem;
            letter-spacing: 0.15em; text-transform: uppercase;
            color: var(--bg-deep); cursor: pointer; transition: all 0.3s;
        }
        .auth-btn:hover{
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 168, 85, 0.3);
        }
        .auth-btn:disabled{ opacity: 0.6; cursor: not-allowed;}
        .auth-error, .auth-success{
            margin-top: 16px; padding: 12px; border-radius: 4px;
            font-size: 0.9rem; display: none;
        }
        .auth-error{
            background: rgba(180, 60, 60, 0.15);
            border: 1px solid rgba(180, 60, 60, 0.3);
            color: #e07070;
        }
        .auth-success{
            background: rgba(74, 158, 107, 0.15);
            border: 1px solid rgba(74, 158, 107, 0.3);
            color: #70e070;
        }
        .auth-error.visible, .auth-success.visible{ display: block;}
        .loading{
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(212, 168, 85, 0.3);
            border-radius: 50%; border-top-color: var(--gold);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin{ to{ transform: rotate(360deg);} }
        /* ===== MODAL DE AVATAR ===== */
        #avatar-modal{
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 300;
            padding: 24px;
        }
        #avatar-modal.active{
            opacity: 1;
            visibility: visible;
        }
        .avatar-modal-content{
            width: 100%;
            max-width: 420px;
            background: var(--bg-card);
            border: 1px solid var(--border-gold);
            border-radius: 16px;
            padding: 32px 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            position: relative;
        }
        .avatar-modal-close{
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            line-height: 1;
        }
        .avatar-modal-close:hover{
            color: var(--gold);
        }
        .avatar-modal-title{
            font-family: var(--font-display);
            font-size: 1.1rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 28px;
        }
        
        /* ===== ESTILOS PARA AVATAR COM IMAGEM ===== */
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem não distorça */
            border-radius: 50%;
            display: block;
        }

        /* Ajuste no container do avatar no perfil */
        #profile-avatar {
            width: 90px; 
            height: 90px;
            margin: 0 auto 16px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Corta a imagem em círculo */
            border: 2px solid var(--gold);
            box-shadow: 0 0 15px rgba(212, 168, 85, 0.2);
            font-size: 2.5rem; /* Para emojis antigos */
        }

        /* Ajuste nas opções do Modal */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .avatar-option {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-subtle);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden; /* Importante */
            padding: 0; /* Remove padding para imagem encher tudo */
            transition: all 0.3s;
        }

        .avatar-option:hover {
            border-color: var(--gold-dim);
            transform: scale(1.05);
        }

        .avatar-option.selected {
            border-color: var(--gold);
            box-shadow: 0 0 15px var(--gold-glow);
            transform: scale(1.1);
            position: relative;
        }
        
        /* Marca visual de selecionado */
        .avatar-option.selected::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 3px solid var(--gold);
            border-radius: 50%;
        }

        .avatar-save-btn{
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--gold-dim) 0%, var(--gold) 100%);
            border: 1px solid var(--gold-light);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--bg-deep);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .avatar-save-btn:hover{
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-bright) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 168, 85, 0.4);
        }
        .avatar-save-btn:disabled{
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        /* ===== HOME COM SCROLL E SHADOW ===== */
        .home-screen-content{
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
            padding: 24px 24px 100px 24px; /* Padding extra no final */
            position: relative;
        }
        /* Ajustes de tamanho para as caixas */
        .tab-content{
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }
        .tab-content.active{
            display: block;
        }
        /* Shadow gradient para todas as tabs */
        .tab-content::after{
            content: '';
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to top, rgba(8, 7, 9, 1) 0%, rgba(8, 7, 9, 0.8) 50%, transparent 100%);
            pointer-events: none;
            z-index: 50;
        }
        /* Shadow específico para home */
        .home-screen-content::after{
            content: '';
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to top, rgba(8, 7, 9, 1) 0%, rgba(8, 7, 9, 0.8) 50%, transparent 100%);
            pointer-events: none;
            z-index: 50;
        }
        /* ===== ESTRUTURA PRINCIPAL COM NAVBAR ===== */
        #main-app{
            position: fixed; inset: 0;
            display: flex; flex-direction: column;
            transition: opacity 0.6s var(--ease-out), visibility 0.6s;
            z-index: 100;
        }
        #main-app.hidden{ opacity: 0; visibility: hidden; pointer-events: none;}
        .app-content{
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 70px;
        }
        .tab-content{
            display: none;
            width: 100%;
            height: 100%;
        }
        .tab-content.active{
            display: flex;
            flex-direction: column;
        }
        /* Bottom Navigation */
        .bottom-nav{
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-deep) 100%);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            z-index: 150;
        }
        .nav-item{
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .nav-icon{
            width: 26px;
            height: 26px;
            color: var(--text-dim);
            transition: all 0.3s;
            margin-bottom: 4px;
        }
        .nav-label{
            font-family: var(--font-display);
            font-size: 0.5rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-dim);
            transition: all 0.3s;
        }
        .nav-item.active .nav-icon{
            color: var(--gold);
            filter: drop-shadow(0 0 8px var(--gold-glow));
        }
        .nav-item.active .nav-label{
            color: var(--gold);
        }
        .nav-item::before{
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--gold);
            transition: width 0.3s var(--ease-out);
        }
        .nav-item.active::before{
            width: 40px;
        }
        /* ===== TELA INICIAL (HOME TAB) ===== */
        .home-screen-content{
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            padding: 28px;
        }
        /* Cruz decorativa */
        .home-cross{
            width: 50px;
            height: 70px;
            position: relative;
            margin-bottom: 24px;
        }
        .home-cross::before,
        .home-cross::after{
            content: '';
            position: absolute;
            background: linear-gradient(180deg, var(--gold-bright) 0%, var(--gold) 50%, var(--gold-dim) 100%);
            border-radius: 2px;
        }
        .home-cross::before{
            width: 4px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }
        .home-cross::after{
            width: 36px;
            height: 4px;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
        }
        .home-cross-glow{
            position: absolute;
            inset: -20px;
            background: radial-gradient(circle, var(--gold-glow) 0%, transparent 70%);
            opacity: 0.5;
            animation: cross-glow 4s ease-in-out infinite;
        }
        @keyframes cross-glow{
            0%, 100%{ opacity: 0.4; transform: scale(0.95);}
            50%{ opacity: 0.7; transform: scale(1.05);}
        }
        .home-title{
            font-family: var(--font-display);
            font-size: 2.2rem;
            font-weight: 500;
            letter-spacing: 0.25em;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }
        .home-subtitle{
            font-family: var(--font-body);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .home-method{
            font-family: var(--font-display);
            font-size: 0.6rem;
            letter-spacing: 0.3em;
            color: var(--gold);
            text-transform: uppercase;
            margin-bottom: 36px;
            padding: 10px 20px;
            border: 1px solid var(--border-gold);
            background: linear-gradient(135deg, rgba(212, 168, 85, 0.08) 0%, rgba(212, 168, 85, 0.02) 100%);
            position: relative;
        }
        .home-method::before,
        .home-method::after{
            content: '✦';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gold-dim);
            font-size: 0.5rem;
        }
        .home-method::before{ left: 8px;}
        .home-method::after{ right: 8px;}
        .today-info{
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
            text-align: center;
        }
        .today-info strong{
            color: var(--gold);
            font-weight: 500;
        }
        .menu-section{
            width: 100%;
            max-width: 360px;
            margin-bottom: 24px;
        }
        .menu-label{
            font-family: var(--font-display);
            font-size: 0.55rem;
            letter-spacing: 0.35em;
            color: var(--text-dim);
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .menu-label::before,
        .menu-label::after{
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
        }
        .menu-grid{
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        /* ===== BOTÕES ELEGANTES ===== */
        .btn-mystery{
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 22px 28px;
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.5s var(--ease-smooth);
            position: relative;
            overflow: hidden;
        }
        /* Efeito de luz que passa */
        .btn-mystery::before{
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(212, 168, 85, 0.15) 50%, 
                transparent 100%);
            transition: left 0.7s var(--ease-smooth);
        }
        /* Linha dourada inferior */
        .btn-mystery::after{
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            transition: width 0.5s var(--ease-smooth);
        }
        .btn-mystery:hover::before{
            left: 100%;
        }
        .btn-mystery:hover::after{
            width: 70%;
        }
        .btn-mystery:hover{
            border-color: var(--gold-dim);
            color: var(--gold);
            background: rgba(212, 168, 85, 0.06);
            transform: translateY(-4px);
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.4),
                0 0 50px rgba(212, 168, 85, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        .btn-mystery:active{
            transform: translateY(-2px);
            transition: transform 0.1s;
        }
        /* Botão do Rosário Completo */
        .btn-complete{
            background: linear-gradient(135deg, rgba(107, 45, 61, 0.2) 0%, rgba(107, 45, 61, 0.08) 100%);
            border: 1px solid rgba(138, 61, 80, 0.35);
            color: var(--cream);
            padding: 24px 28px;
            margin-top: 4px;
        }
        .btn-complete::before{
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(212, 168, 85, 0.2) 50%, 
                transparent 100%);
        }
        .btn-complete:hover{
            background: linear-gradient(135deg, rgba(107, 45, 61, 0.3) 0%, rgba(107, 45, 61, 0.12) 100%);
            border-color: var(--gold-dim);
            box-shadow: 
                0 18px 45px rgba(0, 0, 0, 0.45),
                0 0 60px rgba(212, 168, 85, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);
        }
        .btn-complete small{
            display: block;
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-style: italic;
            font-weight: 400;
            letter-spacing: 0.02em;
            text-transform: none;
            color: var(--text-muted);
            margin-top: 8px;
        }
        /* Botão de áudio */
        .audio-toggle{
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--ease-smooth);
            z-index: 200;
        }
        .audio-toggle:hover{
            border-color: var(--gold-dim);
            color: var(--gold);
            transform: scale(1.05);
        }
        .audio-toggle.active{
            color: var(--gold);
            border-color: var(--gold-dim);
            background: rgba(212, 168, 85, 0.12);
            box-shadow: 0 0 20px rgba(212, 168, 85, 0.2);
        }
        .audio-toggle svg{ width: 22px; height: 22px;}
        /* ===== TELA DE ORAÇÃO ===== */
        #prayer-screen{
            position: fixed; inset: 0;
            display: flex; flex-direction: row;
            background: var(--bg-deep);
            opacity: 0; visibility: hidden;
            transition: opacity 0.6s var(--ease-out), visibility 0.6s;
            z-index: 200;
        }
        #prayer-screen.active{ opacity: 1; visibility: visible;}
        /* Trilho do Rosário */
        .rosary-rail{
            position: relative;
            width: var(--rail-width);
            height: 100%;
            background: linear-gradient(90deg, var(--bg-primary) 0%, var(--bg-deep) 100%);
            border-right: 1px solid rgba(212, 168, 85, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }
        .rosary-rail::before,
        .rosary-rail::after{
            content: '';
            position: absolute;
            left: 0; right: 0;
            height: 140px;
            z-index: 10;
            pointer-events: none;
        }
        .rosary-rail::before{
            top: 0;
            background: linear-gradient(180deg, var(--bg-deep) 0%, rgba(8, 7, 9, 0.8) 50%, transparent 100%);
        }
        .rosary-rail::after{
            bottom: 0;
            background: linear-gradient(0deg, var(--bg-deep) 0%, rgba(8, 7, 9, 0.8) 50%, transparent 100%);
        }
        /* Corrente dourada */
        .rosary-chain{
            position: absolute;
            top: 50%; left: 50%;
            width: 3px;
            height: calc(100% + 300px);
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, 
                transparent 0%, 
                var(--gold-dark) 3%,
                var(--gold-dim) 15%,
                var(--gold) 50%,
                var(--gold-dim) 85%,
                var(--gold-dark) 97%,
                transparent 100%);
            opacity: 0.4;
            border-radius: 2px;
        }
        /* Guia central */
        .center-guide{
            position: absolute;
            top: 50%;
            left: 15%;
            right: 15%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212, 168, 85, 0.2), transparent);
            transform: translateY(-50%);
            z-index: 5;
        }
        /* Container das contas */
        #bead-track{
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, 0);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--bead-gap);
            transition: transform 0.55s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
            padding: 100px 0;
        }
        /* ===== CONTAS BRILHANTES E REALISTAS ===== */
        .bead{
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.45s var(--ease-smooth);
            position: relative;
            flex-shrink: 0;
            background: transparent;
        }
        /* Aura de luz ao redor da conta ativa */
        .bead::before{
            content: '';
            position: absolute;
            inset: -15px;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: scale(0.5);
            z-index: -1;
        }
        .bead.active::before{
            opacity: 1;
            transform: scale(1);
            animation: bead-aura 2.5s ease-in-out infinite;
        }
        @keyframes bead-aura{
            0%, 100%{ opacity: 1; transform: scale(1);}
            50%{ opacity: 0.6; transform: scale(1.25);}
        }
        /* Brilho interno sutil */
        .bead::after{
            content: '';
            position: absolute;
            inset: 3px;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .bead:hover::after,
        .bead.active::after{
            opacity: 1;
        }
        /* ===== CONTA AVE MARIA - Círculo dourado hollow pequeno ===== */
        .bead.ave{
            width: var(--bead-size-small);
            height: var(--bead-size-small);
            border: 2.5px solid var(--gold);
            box-shadow: 
                0 0 12px rgba(212, 168, 85, 0.4),
                0 0 20px rgba(212, 168, 85, 0.15),
                inset 0 0 8px rgba(212, 168, 85, 0.2);
        }
        .bead.ave::before{
            background: radial-gradient(circle, rgba(212, 168, 85, 0.5) 0%, transparent 70%);
        }
        .bead.ave::after{
            background: radial-gradient(circle at 30% 30%, rgba(255, 230, 150, 0.4) 0%, transparent 60%);
        }
        .bead.ave:hover{
            transform: scale(1.12);
            border-color: var(--gold-bright);
            box-shadow: 
                0 0 20px rgba(212, 168, 85, 0.6),
                0 0 35px rgba(212, 168, 85, 0.3),
                inset 0 0 15px rgba(212, 168, 85, 0.3);
        }
        .bead.ave.active{
            width: var(--bead-size);
            height: var(--bead-size);
            transform: scale(1.2);
            border-width: 3px;
            border-color: var(--gold-bright);
            box-shadow: 
                0 0 30px rgba(212, 168, 85, 0.8),
                0 0 50px rgba(212, 168, 85, 0.5),
                0 0 80px rgba(212, 168, 85, 0.25),
                inset 0 0 25px rgba(212, 168, 85, 0.4);
            animation: bead-pulse 2s ease-in-out infinite;
        }
        @keyframes bead-pulse{
            0%, 100%{ 
                border-color: var(--gold-bright);
                box-shadow: 
                    0 0 30px rgba(212, 168, 85, 0.8),
                    0 0 50px rgba(212, 168, 85, 0.5),
                    0 0 80px rgba(212, 168, 85, 0.25),
                    inset 0 0 25px rgba(212, 168, 85, 0.4);
            }
            50%{ 
                border-color: #ffe890;
                box-shadow: 
                    0 0 40px rgba(212, 168, 85, 1),
                    0 0 70px rgba(212, 168, 85, 0.6),
                    0 0 100px rgba(212, 168, 85, 0.3),
                    inset 0 0 35px rgba(212, 168, 85, 0.5);
            }
        }
        /* ===== CONTA PAI NOSSO - Círculo dourado hollow maior ===== */
        .bead.pater{
            width: calc(var(--bead-size-small) + 14px);
            height: calc(var(--bead-size-small) + 14px);
            border: 3px solid var(--gold-bright);
            box-shadow: 
                0 0 18px rgba(212, 168, 85, 0.6),
                0 0 30px rgba(212, 168, 85, 0.3),
                inset 0 0 12px rgba(212, 168, 85, 0.3);
        }
        .bead.pater::before{
            background: radial-gradient(circle, var(--gold-glow) 0%, transparent 65%);
        }
        .bead.pater::after{
            background: radial-gradient(circle at 25% 25%, rgba(255, 240, 180, 0.6) 0%, transparent 55%);
        }
        .bead.pater:hover{
            transform: scale(1.12);
            border-color: #ffe890;
            box-shadow: 
                0 0 25px rgba(212, 168, 85, 0.8),
                0 0 45px rgba(212, 168, 85, 0.5),
                inset 0 0 20px rgba(212, 168, 85, 0.4);
        }
        .bead.pater.active{
            width: var(--bead-size-pater);
            height: var(--bead-size-pater);
            transform: scale(1.2);
            border-width: 4px;
            border-color: #ffe890;
            box-shadow: 
                0 0 40px rgba(212, 168, 85, 1),
                0 0 65px rgba(212, 168, 85, 0.7),
                0 0 100px rgba(212, 168, 85, 0.4),
                inset 0 0 30px rgba(212, 168, 85, 0.5);
            animation: bead-pulse-pater 2s ease-in-out infinite;
        }
        @keyframes bead-pulse-pater{
            0%, 100%{ 
                border-color: #ffe890;
                box-shadow: 
                    0 0 40px rgba(212, 168, 85, 1),
                    0 0 65px rgba(212, 168, 85, 0.7),
                    0 0 100px rgba(212, 168, 85, 0.4),
                    inset 0 0 30px rgba(212, 168, 85, 0.5);
            }
            50%{ 
                border-color: #fff5c0;
                box-shadow: 
                    0 0 50px rgba(255, 230, 150, 1),
                    0 0 85px rgba(212, 168, 85, 0.8),
                    0 0 120px rgba(212, 168, 85, 0.5),
                    inset 0 0 40px rgba(212, 168, 85, 0.6);
            }
        }
        /* ===== CONTA ESPECIAL - Círculo dourado hollow médio com toque burgundy ===== */
        .bead.special{
            width: calc(var(--bead-size-small) + 10px);
            height: calc(var(--bead-size-small) + 10px);
            border: 2.5px solid var(--gold);
            box-shadow: 
                0 0 15px rgba(212, 168, 85, 0.5),
                0 0 25px rgba(138, 61, 80, 0.3),
                inset 0 0 10px rgba(212, 168, 85, 0.25);
        }
        .bead.special::before{
            background: radial-gradient(circle, rgba(212, 168, 85, 0.4) 0%, rgba(138, 61, 80, 0.2) 40%, transparent 70%);
        }
        .bead.special::after{
            background: radial-gradient(circle at 28% 28%, rgba(255, 230, 150, 0.5) 0%, transparent 55%);
        }
        .bead.special:hover{
            transform: scale(1.12);
            border-color: var(--gold-bright);
            box-shadow: 
                0 0 22px rgba(212, 168, 85, 0.7),
                0 0 38px rgba(138, 61, 80, 0.4),
                inset 0 0 18px rgba(212, 168, 85, 0.35);
        }
        .bead.special.active{
            width: calc(var(--bead-size) + 10px);
            height: calc(var(--bead-size) + 10px);
            transform: scale(1.2);
            border-width: 3.5px;
            border-color: var(--gold-bright);
            box-shadow: 
                0 0 35px rgba(212, 168, 85, 0.85),
                0 0 55px rgba(138, 61, 80, 0.5),
                0 0 85px rgba(212, 168, 85, 0.35),
                inset 0 0 28px rgba(212, 168, 85, 0.45);
            animation: bead-pulse-special 2.2s ease-in-out infinite;
        }
        @keyframes bead-pulse-special{
            0%, 100%{ 
                border-color: var(--gold-bright);
                box-shadow: 
                    0 0 35px rgba(212, 168, 85, 0.85),
                    0 0 55px rgba(138, 61, 80, 0.5),
                    0 0 85px rgba(212, 168, 85, 0.35),
                    inset 0 0 28px rgba(212, 168, 85, 0.45);
            }
            50%{ 
                border-color: #ffe890;
                box-shadow: 
                    0 0 45px rgba(212, 168, 85, 1),
                    0 0 70px rgba(138, 61, 80, 0.6),
                    0 0 105px rgba(212, 168, 85, 0.45),
                    inset 0 0 38px rgba(212, 168, 85, 0.55);
            }
        }
        /* ===== CONTAS RETANGULARES (Glória e Fátima) ===== */
        .bead.rectangle-bead{
            border-radius: 18px !important;
            width: calc(var(--bead-size-small) + 20px) !important;
            height: calc(var(--bead-size-small) - 4px) !important;
        }
        .bead.rectangle-bead.active{
            width: calc(var(--bead-size) + 24px) !important;
            height: var(--bead-size) !important;
            border-radius: 20px !important;
        }
        .bead.rectangle-bead:hover{
            transform: scale(1.08);
        }
        .bead.rectangle-bead.active{
            transform: scale(1.15);
        }

        /* ===== IMAGEM DO MISTÉRIO (AJUSTADA) ===== */
        .mystery-image {
            width: auto;
            max-width: 100%;
            height: auto;
            max-height: 120px; /* Começa pequena */
            margin: 12px auto;
            display: none; 
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: zoom-in;
            border-radius: 8px;
        }

        .mystery-image.visible {
            display: block;
            opacity: 1;
            transform: scale(1);
        }

        .mystery-image.expanded {
            max-height: 60vh; /* Cresce ao clicar */
            max-width: 95%;
            cursor: zoom-out;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 50;
        }

        /* ===== CAMPOS DE PERFIL ===== */
        .profile-section {
            width: 100%;
            max-width: 360px;
            margin-bottom: 24px;
        }
        
        .profile-label {
            display: block;
            font-family: var(--font-display);
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            margin-top: 16px;
        }

        .profile-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px;
            font-family: var(--font-body);
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .profile-input:focus {
            outline: none;
            border-color: var(--gold-dim);
            background: rgba(255, 255, 255, 0.08);
        }

        .profile-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .small-btn-row {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 12px;
        }

        .small-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-secondary);
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
        }

        .small-btn:hover {
            border-color: var(--gold-dim);
            color: var(--gold);
            background: rgba(212, 168, 85, 0.05);
        }

        /* ===== ESTILOS DA INBOX (NOVO) ===== */
        #inbox-modal {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 350; padding: 24px;
        }
        #inbox-modal.active { opacity: 1; visibility: visible; }

        .inbox-card {
            background: linear-gradient(135deg, rgba(212, 168, 85, 0.1) 0%, rgba(212, 168, 85, 0.02) 100%);
            border: 1px solid var(--border-gold);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            animation: slideUp 0.3s ease-out;
        }

        .inbox-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }

        .inbox-time {
            font-size: 0.7rem; color: var(--text-dim); font-family: var(--font-body);
        }

        .inbox-body {
            font-family: var(--font-body); font-size: 0.95rem; color: var(--text-primary); line-height: 1.5; font-style: italic;
        }
        
        .challenge-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
        }
        
        .btn-challenge-accept {
            flex: 1;
            padding: 8px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
            border: none;
            border-radius: 6px;
            color: var(--bg-deep);
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-delete-msg {
            background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;
        }
        .btn-delete-msg:hover { color: #e07070; }

        .empty-inbox {
            text-align: center; padding: 40px 20px; color: var(--text-muted); font-style: italic; font-family: var(--font-body);
        }
        
        /* BARRA DE PROGRESSO DO DESAFIO NO PERFIL */
        .challenge-progress-container {
            width: 100%;
            max-width: 360px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, rgba(212, 168, 85, 0.15) 0%, rgba(212, 168, 85, 0.05) 100%);
            border: 1px solid var(--gold);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .challenge-title {
            font-family: var(--font-display);
            font-size: 0.9rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .challenge-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .challenge-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .challenge-name {
            font-size: 0.8rem;
            width: 80px;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .challenge-track {
            flex: 1;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .challenge-fill {
            height: 100%;
            background: var(--gold);
            width: 0%;
            transition: width 0.5s ease-out;
        }

        /* Conteúdo principal */
        .prayer-main{
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
        }
        .prayer-header{
            padding: 18px 24px;
            background: linear-gradient(180deg, var(--bg-primary) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .back-btn{
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-display);
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            cursor: pointer;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .back-btn:hover{
            color: var(--gold);
            transform: translateX(-3px);
        }
        .back-btn svg{ width: 16px; height: 16px;}
        .progress-compact{
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .progress-bar-mini{
            width: 90px;
            height: 3px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill-mini{
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dim), var(--gold), var(--gold-bright));
            transition: width 0.5s var(--ease-out);
            border-radius: 2px;
        }
        .progress-text{
            font-family: var(--font-display);
            font-size: 0.65rem;
            color: var(--text-dim);
            letter-spacing: 0.08em;
        }
        .prayer-body{
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 32px 32px;
            overflow-y: auto;
        }
        .prayer-group{
            font-family: var(--font-display);
            font-size: 0.6rem;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            color: var(--gold-dim);
            margin-bottom: 8px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.45s var(--ease-out);
        }
        .prayer-group.visible{ opacity: 1; transform: translateY(0);}
        .prayer-mystery{
            font-family: var(--font-body);
            font-size: 1.2rem;
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: 18px;
            min-height: 1.5em;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.45s var(--ease-out) 0.05s;
        }
        .prayer-mystery.visible{ opacity: 1; transform: translateY(0);}
        .prayer-name{
            font-family: var(--font-display);
            font-size: 2.2rem;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            opacity: 0;
            transform: translateY(-12px);
            transition: all 0.45s var(--ease-out) 0.1s;
        }
        .prayer-name.visible{ opacity: 1; transform: translateY(0);}
        .prayer-count{
            font-family: var(--font-display);
            font-size: 0.7rem;
            letter-spacing: 0.18em;
            color: var(--text-dim);
            margin-bottom: 24px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.45s var(--ease-out) 0.15s;
        }
        .prayer-count.visible{ opacity: 1; transform: translateY(0);}
        /* Caixa de meditação refinada */
        .meditation-box{
            background: linear-gradient(135deg, rgba(212, 168, 85, 0.1) 0%, rgba(212, 168, 85, 0.03) 100%);
            border-left: 3px solid var(--gold);
            padding: 20px 24px;
            margin-bottom: 24px;
            opacity: 0;
            transform: translateX(-15px);
            transition: all 0.5s var(--ease-out) 0.2s;
            position: relative;
        }
        .meditation-box::before{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, var(--gold-dim), transparent);
        }
        .meditation-box.visible{ opacity: 1; transform: translateX(0);}
        .meditation-label{
            font-family: var(--font-display);
            font-size: 0.55rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 10px;
        }
        .meditation-text{
            font-family: var(--font-body);
            font-size: 1.2rem;
            font-style: italic;
            color: var(--text-primary);
            line-height: 1.75;
        }
        /* Toggle do texto da oração */
        .prayer-text-toggle{
            background: none;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            font-family: var(--font-display);
            font-size: 0.6rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            padding: 12px 18px;
            cursor: pointer;
            transition: all 0.35s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 14px;
        }
        .prayer-text-toggle:hover{
            border-color: var(--border-gold);
            color: var(--gold);
            background: rgba(212, 168, 85, 0.04);
        }
        .prayer-text-toggle svg{
            width: 14px;
            height: 14px;
            transition: transform 0.35s var(--ease-out);
        }
        .prayer-text-toggle.expanded svg{ transform: rotate(180deg);}
        .prayer-full-text{
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.45s var(--ease-out), opacity 0.35s, padding 0.35s;
            opacity: 0;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
        }
        .prayer-full-text.visible{
            max-height: 420px;
            opacity: 1;
            padding: 18px 20px;
            margin-bottom: 18px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .prayer-full-text p{
            font-family: var(--font-body);
            font-size: 1.05rem;
            color: var(--text-secondary);
            line-height: 1.85;
        }
        /* Footer com navegação */
        .prayer-footer{
            padding: 18px 24px;
            background: linear-gradient(0deg, var(--bg-primary) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            flex-shrink: 0;
        }
        .nav-btn{
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.35s var(--ease-smooth);
        }
        .nav-btn:hover:not(:disabled){
            background: var(--bg-elevated);
            border-color: var(--border-gold);
            color: var(--gold);
            transform: scale(1.08);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        .nav-btn:disabled{ opacity: 0.25; cursor: not-allowed;}
        .nav-btn svg{ width: 24px; height: 24px;}
        .nav-btn.primary{
            width: 68px;
            height: 68px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
            border: none;
            color: var(--bg-deep);
            box-shadow: 0 4px 20px rgba(212, 168, 85, 0.3);
        }
        .nav-btn.primary:hover:not(:disabled){
            background: linear-gradient(135deg, var(--gold-bright) 0%, var(--gold) 100%);
            transform: scale(1.1);
            box-shadow: 0 0 35px rgba(212, 168, 85, 0.5), 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .nav-hint{
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-body);
            font-size: 0.8rem;
            color: var(--text-dim);
            font-style: italic;
            white-space: nowrap;
        }
        /* ===== TELA DE CONCLUSÃO ===== */
        #completion-screen{
            position: fixed; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 28px;
            background: var(--bg-deep);
            z-index: 200;
            opacity: 0; visibility: hidden;
            transition: opacity 0.6s var(--ease-out), visibility 0.6s;
        }
        #completion-screen.active{ opacity: 1; visibility: visible;}
        .completion-icon{
            width: 100px;
            height: 100px;
            color: var(--gold);
            margin-bottom: 28px;
            animation: completion-glow 2.5s ease-in-out infinite;
        }
        @keyframes completion-glow{
            0%, 100%{ filter: drop-shadow(0 0 20px rgba(212, 168, 85, 0.4)); transform: scale(1);}
            50%{ filter: drop-shadow(0 0 40px rgba(212, 168, 85, 0.7)); transform: scale(1.06);}
        }
        .completion-title{
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--text-primary);
            letter-spacing: 0.18em;
            margin-bottom: 10px;
        }
        .completion-subtitle{
            font-family: var(--font-body);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text-secondary);
            text-align: center;
            max-width: 340px;
            margin-bottom: 32px;
            line-height: 1.6;
        }
        .completion-stats{
            display: flex;
            gap: 40px;
            margin-bottom: 36px;
        }
        .stat{ text-align: center;}
        .stat-value{
            font-family: var(--font-display);
            font-size: 2.4rem;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(212, 168, 85, 0.3);
        }
        .stat-label{
            font-family: var(--font-body);
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .btn-home{
            background: var(--bg-card);
            border: 1px solid var(--border-gold);
            color: var(--gold);
            padding: 16px 32px;
            font-family: var(--font-display);
            font-size: 0.85rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.35s;
        }
        .btn-home:hover{
            background: rgba(212, 168, 85, 0.12);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }
        /* ===== RESPONSIVO ===== */
        @media (max-width: 768px){
            :root{
                --bead-size: 54px;
                --bead-size-small: 44px;
                --bead-size-pater: 62px;
                --bead-gap: 18px;
                --rail-width: 85px;
            }
            .rosary-rail{
                order: 2;
                width: var(--rail-width);
                background: linear-gradient(-90deg, var(--bg-primary) 0%, var(--bg-deep) 100%);
                border-right: none;
                border-left: 1px solid rgba(212, 168, 85, 0.06);
            }
            .rosary-rail::before, .rosary-rail::after{ height: 110px;}
            .prayer-main{ order: 1;}
            .prayer-body{ padding: 24px 20px;}
            .prayer-name{ font-size: 1.8rem;}
            .meditation-text{ font-size: 1.1rem;}
            .nav-btn{ width: 52px; height: 52px;}
            .nav-btn.primary{ width: 62px; height: 62px;}
            .nav-hint{ display: none;}
            .progress-bar-mini{ width: 70px;}
            .audio-toggle{ bottom: 110px; right: 14px; width: 44px; height: 44px;}
            .home-title{ font-size: 1.8rem;}
        }
        @media (max-width: 380px){
            :root{
                --rail-width: 75px;
                --bead-size: 50px;
                --bead-size-small: 40px;
                --bead-size-pater: 56px;
            }
            .prayer-body{ padding: 18px 16px;}
            .prayer-name{ font-size: 1.5rem;}
            .meditation-text{ font-size: 1rem;}
            .home-title{ font-size: 1.6rem;}
        }
        @media (max-height: 500px) and (orientation: landscape){
            .rosary-rail{ width: 75px;}
            .prayer-header, .prayer-footer{ padding: 12px 18px;}
            .prayer-body{ padding: 14px 18px;}
            .prayer-name{ font-size: 1.5rem; margin-bottom: 5px;}
            .meditation-box{ padding: 14px 16px; margin-bottom: 14px;}
        }
    </style>
</head>
<div id="custom-alert" class="custom-alert">
    <div class="custom-alert-content">
        <svg class="custom-alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <h3 class="custom-alert-title" id="alert-title">Sucesso!</h3>
        <p class="custom-alert-message" id="alert-message">Operação concluída</p>
        <button type="button" class="custom-alert-btn" onclick="closeCustomAlert()">OK</button>
    </div>
</div>
<div id="confirm-modal" class="custom-alert">
    <div class="custom-alert-content">
        <h3 class="custom-alert-title" id="confirm-title">Confirmar</h3>
        <p class="custom-alert-message" id="confirm-message">Tem certeza?</p>
        <div class="custom-confirm-btn-row">
            <button type="button" class="custom-confirm-btn btn-no" onclick="resolveConfirm(false)">Cancelar</button>
            <button type="button" class="custom-confirm-btn btn-yes" onclick="resolveConfirm(true)">Confirmar</button>
        </div>
    </div>
</div>

<body>
<div id="auth-screen">
    <div class="auth-container">
        <div class="auth-logo">
            <img src="/icon-192.png" alt="Logo Rosário">
        </div>
        <h1 class="auth-title">Rosário</h1>
        <p class="auth-subtitle">Método de São Luís de Montfort</p>
        <div class="auth-info">
            ✨ <strong>Autenticação Segura:</strong> Seus dados são protegidos com Firebase!
        </div>
        <div class="auth-warning">
            ⚠️ <strong>Atenção:</strong> Não há recuperação de senha. Anote seus dados em local seguro.
        </div>
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login" type="button">Entrar</button>
            <button class="auth-tab" data-tab="register" type="button">Criar Conta</button>
        </div>
        <form id="login-form" class="auth-form active">
            <div class="input-group">
                <label class="input-label">Nome de Usuário</label>
                <input type="text" class="input-field" id="login-username" placeholder="Seu nome de usuário" required autocomplete="username">
            </div>
            <div class="input-group">
                <label class="input-label">Senha</label>
                <input type="password" class="input-field" id="login-password" placeholder="Sua senha" required autocomplete="current-password">
            </div>
            <button type="submit" class="auth-btn" id="login-btn">Entrar</button>
            <div class="auth-error" id="login-error"></div>
        </form>
        <form id="register-form" class="auth-form">
            <div class="input-group">
                <label class="input-label">Nome de Usuário</label>
                <input type="text" class="input-field" id="register-username" placeholder="Escolha um nome" required minlength="3" autocomplete="username">
            </div>
            <div class="input-group">
                <label class="input-label">Nome Completo</label>
                <input type="text" class="input-field" id="register-displayname" placeholder="Seu nome completo" required minlength="2" autocomplete="name">
            </div>
            <div class="input-group">
                <label class="input-label">Crie uma Senha</label>
                <input type="password" class="input-field" id="register-password" placeholder="Mínimo 6 caracteres" required minlength="6" autocomplete="new-password">
            </div>
            <div class="input-group">
                <label class="input-label">Confirme a Senha</label>
                <input type="password" class="input-field" id="register-confirm" placeholder="Repita a senha" required autocomplete="new-password">
            </div>
            <button type="submit" class="auth-btn" id="register-btn">Criar Conta</button>
            <div class="auth-error" id="register-error"></div>
            <div class="auth-success" id="register-success"></div>
        </form>
    </div>
</div>
<div id="main-app" class="hidden">
    <div class="app-content">
        <div id="tab-home" class="tab-content active">
            <div class="home-screen-content" style="padding: 24px;">
                <div style="text-align: center; margin-bottom: 28px;">
                    <p style="font-family: var(--font-body); font-size: 1rem; color: var(--text-muted); margin-bottom: 4px;">
                        Bem-vindo(a),
                    </p>
                    <h2 style="font-family: var(--font-display); font-size: 1.4rem; color: var(--text-primary); letter-spacing: 0.1em;" id="home-user-name">
                        Peregrino
                    </h2>
                </div>
                <div style="width: 100%; max-width: 360px; margin: 0 auto 24px; background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 32px 24px; text-align: center; position: relative; overflow: visible; min-height: 200px;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold-dim), var(--gold), var(--gold-dim));"></div>
                    <svg style="width: 50px; height: 50px; margin: 0 auto 12px; color: var(--gold);" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <div style="font-family: var(--font-display); font-size: 3.5rem; font-weight: 600; color: var(--gold); line-height: 1; text-shadow: 0 0 30px var(--gold-glow);" id="home-streak-count">0</div>
                    <div style="font-family: var(--font-display); font-size: 0.7rem; letter-spacing: 0.25em; text-transform: uppercase; color: var(--text-muted); margin-top: 8px;">Dias Consecutivos</div>
                    <p style="font-family: var(--font-body); font-size: 0.95rem; font-style: italic; color: var(--text-dim); margin-top: 12px;" id="home-streak-message">Comece hoje sua jornada de oração</p>
                </div>
                <div style="width: 100%; max-width: 360px; margin: 0 auto 24px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px; min-height: 120px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 14px;">
                        <svg style="width: 24px; height: 24px; color: var(--burgundy-light);" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted);">Intenção do Dia</span>
                    </div>
                    <p style="font-family: var(--font-body); font-size: 1.1rem; font-style: italic; color: var(--text-secondary); line-height: 1.6;" id="home-intention">Carregando...</p>
                </div>
                <div style="width: 100%; max-width: 360px; margin: 0 auto 28px; text-align: center;">
                    <p style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 4px;" id="home-today-day">Segunda-feira</p>
                    <p style="font-family: var(--font-body); font-size: 1.1rem; color: var(--gold);" id="home-today-mystery">Mistérios Gozosos</p>
                </div>
            </div>
        </div>
        <div id="tab-rosary" class="tab-content">
            <div style="padding: 24px 24px 100px 24px; min-height: 100%;">
                <h2 style="font-family: var(--font-display); font-size: 1.2rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); text-align: center; margin-bottom: 32px;">
                    Escolha o Rosário
                </h2>
                <div style="width: 100%; max-width: 360px; margin: 0 auto 32px; text-align: center; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px;">
                    <p style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px;" id="rosary-today-day">Segunda-feira</p>
                    <p style="font-family: var(--font-body); font-size: 1.15rem; color: var(--gold); margin-bottom: 4px;" id="rosary-today-mystery">Mistérios Gozosos</p>
                    <p style="font-family: var(--font-body); font-size: 0.85rem; color: var(--text-dim); font-style: italic;">Recomendado para hoje</p>
                </div>
                <div style="width: 100%; max-width: 360px; margin: 0 auto;">
                    <div style="display: flex; flex-direction: column; gap: 14px;">
                        <button type="button" class="btn-mystery" onclick="app.start('gozosos')" style="padding: 20px 18px; font-size: 0.9rem; width: 100%;">
                            Mistérios Gozosos
                        </button>
                        <button type="button" class="btn-mystery" onclick="app.start('dolorosos')" style="padding: 20px 18px; font-size: 0.9rem; width: 100%;">
                            Mistérios Dolorosos
                        </button>
                        <button type="button" class="btn-mystery" onclick="app.start('gloriosos')" style="padding: 20px 18px; font-size: 0.9rem; width: 100%;">
                            Mistérios Gloriosos
                        </button>
                        <button type="button" class="btn-mystery btn-complete" onclick="app.start('completo')" style="padding: 24px 18px; font-size: 0.95rem; width: 100%; margin-top: 8px;">
                            Rosário Completo
                            <small style="display: block; margin-top: 6px; font-size: 0.75rem; opacity: 0.8;">Gozosos, Dolorosos e Gloriosos</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-calendar" class="tab-content">
            <div style="padding: 24px 24px 100px 24px; min-height: 100%;">
                <h2 style="font-family: var(--font-display); font-size: 1.2rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); text-align: center; margin-bottom: 24px;">
                    Calendário de Oração
                </h2>
                <div style="width: 100%; max-width: 400px; margin: 0 auto 24px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 14px;">
                        <svg style="width: 24px; height: 24px; color: var(--burgundy-light);" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted);">Intenção do Dia</span>
                    </div>
                    <p style="font-family: var(--font-body); font-size: 1.05rem; font-style: italic; color: var(--text-secondary); line-height: 1.6;" id="calendar-intention">Carregando...</p>
                </div>
                <div style="width: 100%; max-width: 400px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: space-between;">
                    <button type="button" id="prev-month-btn" style="background: none; border: 1px solid var(--border-subtle); border-radius: 4px; padding: 8px 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='var(--gold-dim)'; this.style.color='var(--gold)';" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.color='var(--text-secondary)';">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                    <h3 style="font-family: var(--font-display); font-size: 1rem; letter-spacing: 0.1em; color: var(--text-primary);" id="calendar-month-year">Janeiro 2026</h3>
                    <button type="button" id="next-month-btn" style="background: none; border: 1px solid var(--border-subtle); border-radius: 4px; padding: 8px 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='var(--gold-dim)'; this.style.color='var(--gold)';" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.color='var(--text-secondary)';">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </button>
                </div>
                <div style="width: 100%; max-width: 400px; margin: 0 auto; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center;">Dom</div>
                        <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center;">Seg</div>
                        <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center;">Ter</div>
                        <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center;">Qua</div>
                        <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center;">Qui</div>
                        <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center;">Sex</div>
                        <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center;">Sáb</div>
                    </div>
                    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                        </div>
                </div>
                <div style="width: 100%; max-width: 400px; margin: 24px auto 0; display: flex; gap: 16px; justify-content: center; font-family: var(--font-body); font-size: 0.85rem; color: var(--text-muted);">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 8px var(--gold-glow);"></div>
                        <span>Rezou</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; border: 1px solid var(--border-subtle);"></div>
                        <span>Não rezou</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-friends" class="tab-content">
            <div style="padding: 24px 24px 100px 24px; min-height: 100%;">
                
                <div id="friends-main-view">
                    
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 24px; position: relative;">
                        <h2 style="font-family: var(--font-display); font-size: 1.2rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); margin: 0;">
                            Amigos
                        </h2>
                        <button onclick="openInboxModal()" style="background: none; border: none; color: var(--gold); position: relative; cursor: pointer;">
                            <svg style="width: 28px; height: 28px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                            <div id="inbox-badge" style="position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: #e07070; border-radius: 50%; display: none; border: 2px solid var(--bg-deep);"></div>
                        </button>
                    </div>
                    
                    <div style="width: 100%; max-width: 400px; margin: 0 auto 24px;">
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="text" 
                                id="friend-search-input" 
                                placeholder="@nomedeusuario" 
                                style="flex: 1; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; font-family: var(--font-body); font-size: 1rem; color: var(--text-primary);"
                            />
                            <button 
                                type="button" 
                                onclick="searchFriend()" 
                                style="padding: 12px 20px; background: linear-gradient(135deg, var(--gold-dim) 0%, var(--gold) 100%); border: none; border-radius: 8px; color: var(--bg-deep); font-family: var(--font-display); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer;"
                            >
                                Buscar
                            </button>
                        </div>
                        <div id="search-result" style="margin-top: 12px;"></div>
                    </div>

                    <div id="friend-requests-section" style="width: 100%; max-width: 400px; margin: 0 auto 24px; display: none;">
                        <h3 style="font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px;">
                            Pedidos Recebidos
                        </h3>
                        <div id="friend-requests-list"></div>
                    </div>

                    <div style="width: 100%; max-width: 400px; margin: 0 auto;">
                        <h3 style="font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px;">
                            Meus Amigos
                        </h3>
                        <div id="friends-list">
                            <p style="font-family: var(--font-body); font-size: 0.95rem; color: var(--text-dim); font-style: italic; text-align: center; padding: 40px 20px;">
                                Você ainda não tem amigos. Use a busca acima para encontrar outros usuários!
                            </p>
                        </div>
                    </div>
                </div>

                <div id="friend-profile-view" style="display: none; animation: fadeIn 0.4s ease-out;">
                    <button onclick="backToFriendsList()" style="background: none; border: none; color: var(--text-muted); display: flex; align-items: center; gap: 8px; font-family: var(--font-display); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; margin-bottom: 24px;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                        Voltar
                    </button>

                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <div id="fp-avatar-container" style="width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--gold); overflow: hidden; margin-bottom: 16px; background: var(--bg-card); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(212, 168, 85, 0.2);">
                            </div>
                        <h2 id="fp-name" style="font-family: var(--font-display); font-size: 1.6rem; color: var(--text-primary); margin-bottom: 4px;"></h2>
                        <p id="fp-username" style="font-family: var(--font-body); font-size: 1rem; color: var(--gold); margin-bottom: 12px;"></p>
                        
                        <div id="fp-challenge-progress" class="challenge-progress-container" style="display:none;">
                            <div class="challenge-title">⚔️ Desafio 7 Dias</div>
                            <div class="challenge-bars">
                                <div class="challenge-row">
                                    <div class="challenge-name" id="challenge-p1-name">Eu</div>
                                    <div class="challenge-track">
                                        <div class="challenge-fill" id="challenge-p1-fill" style="width: 0%"></div>
                                    </div>
                                    <div style="font-size:0.75rem; width:20px;" id="challenge-p1-count">0</div>
                                </div>
                                <div class="challenge-row">
                                    <div class="challenge-name" id="challenge-p2-name">Amigo</div>
                                    <div class="challenge-track">
                                        <div class="challenge-fill" id="challenge-p2-fill" style="width: 0%; background: var(--burgundy-bright);"></div>
                                    </div>
                                    <div style="font-size:0.75rem; width:20px;" id="challenge-p2-count">0</div>
                                </div>
                            </div>
                        </div>

                        <div id="fp-bio-section" style="width: 100%; max-width: 340px; margin-bottom: 12px; display:none;">
                            <p id="fp-bio" style="font-family: var(--font-body); font-size: 0.95rem; color: var(--text-secondary); line-height: 1.5; font-style: italic;"></p>
                        </div>
                        <div id="fp-intention-section" style="width: 100%; max-width: 340px; margin-bottom: 24px; padding: 12px; background: rgba(107, 45, 61, 0.1); border-radius: 8px; border: 1px solid rgba(138, 61, 80, 0.3); display:none;">
                            <div style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--burgundy-bright); margin-bottom: 4px;">Intenção</div>
                            <p id="fp-intention" style="font-family: var(--font-body); font-size: 0.95rem; color: var(--text-primary); font-style: italic;"></p>
                        </div>

                        <div class="challenge-actions" style="width: 100%; max-width: 340px; margin-bottom: 24px;">
                            <button id="btn-pray-friend" onclick="sendPrayerToFriend()" style="flex:1; padding: 12px; background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-light) 100%); border: 1px solid var(--burgundy-bright); border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.3s;">
                                <span style="font-size: 1.2rem;">🙏</span>
                                <span style="font-family: var(--font-display); font-size: 0.7rem; color: var(--cream); letter-spacing: 0.05em; text-transform: uppercase;">Rezar</span>
                            </button>
                            
                            <button id="btn-challenge-friend" onclick="sendChallengeToFriend()" style="flex:1; padding: 12px; background: linear-gradient(135deg, #2a252e 0%, #1a171c 100%); border: 1px solid var(--gold-dim); border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.3s;">
                                <span style="font-size: 1.2rem;">⚔️</span>
                                <span style="font-family: var(--font-display); font-size: 0.7rem; color: var(--gold); letter-spacing: 0.05em; text-transform: uppercase;">Desafiar</span>
                            </button>
                        </div>
                        
                        <div style="width: 100%; max-width: 360px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="background: rgba(212, 168, 85, 0.05); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 20px 16px; text-align: center;">
                                <div id="fp-streak" style="font-family: var(--font-display); font-size: 2.2rem; font-weight: 600; color: var(--gold);">0</div>
                                <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">Dias Seguidos</div>
                            </div>
                            <div style="background: rgba(212, 168, 85, 0.05); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 20px 16px; text-align: center;">
                                <div id="fp-rosaries" style="font-family: var(--font-display); font-size: 2.2rem; font-weight: 600; color: var(--gold);">0</div>
                                <div style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">Rosários</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div id="tab-profile" class="tab-content">
            <div style="padding: 24px 24px 100px 24px; min-height: 100%; display: flex; flex-direction: column; align-items: center;">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 16px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 2rem; color: var(--bg-deep); cursor: pointer; transition: all 0.3s;" id="profile-avatar" onclick="openAvatarModal()" onmouseover="this.style.transform='scale(1.08)'; this.style.boxShadow='0 8px 25px rgba(212, 168, 85, 0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        👤
                    </div>
                    <h2 style="font-family: var(--font-display); font-size: 1.4rem; letter-spacing: 0.1em; color: var(--text-primary); margin-bottom: 8px;" id="profile-name">
                        Usuário
                    </h2>
                    <p id="profile-handle" style="font-family: var(--font-body); font-size: 0.9rem; color: var(--gold); margin-bottom: 8px;">@usuario</p>
                    
                    <p style="font-family: var(--font-body); font-size: 0.75rem; color: var(--text-dim); font-style: italic; cursor: pointer;" onclick="openAvatarModal()">
                        Clique no avatar para alterar
                    </p>
                </div>

                <div class="profile-section">
                    <label class="profile-label">Sobre Mim (Bio)</label>
                    <textarea id="profile-bio" class="profile-input profile-textarea" placeholder="Escreva uma breve apresentação..."></textarea>
                    
                    <label class="profile-label">Minha Intenção (Pública)</label>
                    <input type="text" id="profile-intention" class="profile-input" placeholder="Ex: Pela saúde da minha família...">
                    
                    <button type="button" onclick="saveProfileData()" style="width: 100%; margin-top: 16px; padding: 12px; background: linear-gradient(135deg, var(--gold-dim) 0%, var(--gold) 100%); border: none; border-radius: 8px; font-family: var(--font-display); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--bg-deep); cursor: pointer; font-weight: 600;">
                        Atualizar Perfil
                    </button>
                </div>
                
                <div id="my-challenge-progress" class="challenge-progress-container" style="display:none;">
                    <div class="challenge-title">⚔️ Desafio Ativo</div>
                    <div class="challenge-bars">
                        <div class="challenge-row">
                            <div class="challenge-name" id="my-challenge-p1">Eu</div>
                            <div class="challenge-track">
                                <div class="challenge-fill" id="my-challenge-p1-fill" style="width: 0%"></div>
                            </div>
                            <div style="font-size:0.75rem; width:20px;" id="my-challenge-p1-count">0</div>
                        </div>
                        <div class="challenge-row">
                            <div class="challenge-name" id="my-challenge-p2">Amigo</div>
                            <div class="challenge-track">
                                <div class="challenge-fill" id="my-challenge-p2-fill" style="width: 0%; background: var(--burgundy-bright);"></div>
                            </div>
                            <div style="font-size:0.75rem; width:20px;" id="my-challenge-p2-count">0</div>
                        </div>
                    </div>
                </div>

                <div style="width: 100%; max-width: 360px; margin-bottom: 24px; background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 32px 24px; text-align: center; position: relative; overflow: visible; min-height: 200px;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold-dim), var(--gold), var(--gold-dim));"></div>
                    <svg style="width: 50px; height: 50px; margin: 0 auto 12px; color: var(--gold);" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <div style="font-family: var(--font-display); font-size: 3.5rem; font-weight: 600; color: var(--gold); line-height: 1; text-shadow: 0 0 30px var(--gold-glow);" id="profile-streak-count">0</div>
                    <div style="font-family: var(--font-display); font-size: 0.7rem; letter-spacing: 0.25em; text-transform: uppercase; color: var(--text-muted); margin-top: 8px;">Dias Consecutivos</div>
                    <p style="font-family: var(--font-body); font-size: 0.95rem; font-style: italic; color: var(--text-dim); margin-top: 12px;" id="profile-streak-message">Comece hoje sua jornada de oração</p>
                </div>
                <div style="width: 100%; max-width: 360px; margin-bottom: 28px;">
                    <h3 style="font-family: var(--font-display); font-size: 0.7rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted); text-align: center; margin-bottom: 16px;">Estatísticas</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div style="background: rgba(212, 168, 85, 0.05); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-family: var(--font-display); font-size: 2rem; font-weight: 600; color: var(--gold);" id="profile-total-rosaries">0</div>
                            <div style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">Rosários</div>
                        </div>
                        <div style="background: rgba(212, 168, 85, 0.05); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-family: var(--font-display); font-size: 2rem; font-weight: 600; color: var(--gold);" id="profile-longest-streak">0</div>
                            <div style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">Recorde</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="background: rgba(138, 61, 80, 0.08); border: 1px solid rgba(138, 61, 80, 0.2); border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-family: var(--font-display); font-size: 2rem; font-weight: 600; color: var(--burgundy-light);" id="profile-total-aves">0</div>
                            <div style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">Ave Marias</div>
                        </div>
                        <div style="background: rgba(138, 61, 80, 0.08); border: 1px solid rgba(138, 61, 80, 0.2); border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-family: var(--font-display); font-size: 2rem; font-weight: 600; color: var(--burgundy-light);" id="profile-total-paters">0</div>
                            <div style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">Pai Nossos</div>
                        </div>
                    </div>
                </div>
                
                <button type="button" style="width: 100%; max-width: 300px; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, rgba(180, 60, 60, 0.2) 0%, rgba(180, 60, 60, 0.08) 100%); border: 1px solid rgba(180, 60, 60, 0.3); border-radius: 8px; font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; color: #c07070; cursor: pointer; transition: all 0.3s;" onclick="firebaseAuth.logoutUser()" onmouseover="this.style.background='rgba(180, 60, 60, 0.15)'; this.style.borderColor='rgba(180, 60, 60, 0.5)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(180, 60, 60, 0.2) 0%, rgba(180, 60, 60, 0.08) 100%)'; this.style.borderColor='rgba(180, 60, 60, 0.3)'; this.style.transform='translateY(0)';">
                    Sair da Conta
                </button>

                <div class="small-btn-row">
                    <a href="/faq" class="small-btn">Dúvidas Frequentes</a>
                    <a href="/privacidade" class="small-btn">Privacidade</a>
                </div>
            </div>
        </div>
    </div>
    <nav class="bottom-nav">
    <button type="button" class="nav-item active" data-tab="home">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        <span class="nav-label">Início</span>
    </button>
    <button type="button" class="nav-item" id="nav-rosary-btn" data-tab="rosary">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.5"/>
            <circle cx="12" cy="3" r="2.5"/>
            <circle cx="19.5" cy="7.5" r="2"/>
            <circle cx="19.5" cy="16.5" r="2"/>
            <circle cx="12" cy="21" r="2.5"/>
            <circle cx="4.5" cy="16.5" r="2"/>
            <circle cx="4.5" cy="7.5" r="2"/>
        </svg>
        <span class="nav-label">Rosário</span>
    </button>
    <button type="button" class="nav-item" data-tab="calendar">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span class="nav-label">Calendário</span>
    </button>
    <button type="button" class="nav-item" data-tab="friends">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <span class="nav-label">Amigos</span>
    </button>
    <button type="button" class="nav-item" data-tab="profile">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
        </svg>
        <span class="nav-label">Perfil</span>
    </button>
</nav>
<div id="avatar-modal">
    <div class="avatar-modal-content">
        <button type="button" class="avatar-modal-close" onclick="closeAvatarModal()">×</button>
        <h2 class="avatar-modal-title">Escolha seu Avatar</h2>
        <div class="avatar-grid" id="avatar-grid">
            </div>
        <button type="button" class="avatar-save-btn" id="avatar-save-btn" onclick="saveAvatar()">
            Salvar Avatar
        </button>
    </div>
</div>

<div id="inbox-modal">
    <div class="avatar-modal-content" style="max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
        <button type="button" class="avatar-modal-close" onclick="closeInboxModal()">×</button>
        <h2 class="avatar-modal-title">Caixa de Entrada</h2>
        
        <div id="inbox-list" style="flex: 1; overflow-y: auto; margin-bottom: 16px; padding-right: 4px;">
            </div>

        <button type="button" class="avatar-modal-close-btn" onclick="closeInboxModal()" style="width: 100%; padding: 14px; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-muted); border-radius: 8px; font-family: var(--font-display); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer;">
            Fechar
        </button>
    </div>
</div>

<div id="prayer-screen">
    <div class="rosary-rail">
        <div class="rosary-chain"></div>
        <div class="center-guide"></div>
        <div id="bead-track"></div>
    </div>
    <div class="prayer-main">
        <header class="prayer-header">
            <button class="back-btn" onclick="app.confirmExit()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Sair
            </button>
            <div class="progress-compact">
                <div class="progress-bar-mini"><div class="progress-fill-mini" id="progress-fill"></div></div>
                <span class="progress-text" id="progress-text">1/59</span>
            </div>
        </header>
        <div class="prayer-body" id="prayer-body">
            <div class="prayer-group" id="prayer-group"></div>
            <div class="prayer-mystery" id="prayer-mystery"></div>
            <h2 class="prayer-name" id="prayer-name"></h2>
            
            <img id="mystery-image" class="mystery-image" alt="Mistério" onclick="app.toggleImageZoom()" />
            
            <div class="prayer-count" id="prayer-count"></div>
            <div class="meditation-box" id="meditation-box">
                <div class="meditation-label">Meditação</div>
                <p class="meditation-text" id="meditation-text"></p>
            </div>
            <button class="prayer-text-toggle" id="prayer-text-toggle" onclick="app.toggleText()">
                <span>Ver texto da oração</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 9l6 6 6-6"/></svg>
            </button>
            <div class="prayer-full-text" id="prayer-full-text"></div>
            <p class="nav-hint">Toque nas contas ou use as setas para navegar</p>
        </div>
        <footer class="prayer-footer">
            <button class="nav-btn" id="prev-btn" onclick="app.prev()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button class="nav-btn primary" id="next-btn" onclick="app.next()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg>
            </button>
        </footer>
    </div>
</div>
<div id="completion-screen">
    <svg class="completion-icon" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="50" cy="50" r="42"/>
        <path d="M28 50l16 16 28-32" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <h2 class="completion-title">Deo Gratias</h2>
    <p class="completion-subtitle" id="completion-msg"></p>
    <div class="completion-stats">
        <div class="stat"><div class="stat-value" id="stat-aves">0</div><div class="stat-label">Ave Marias</div></div>
        <div class="stat"><div class="stat-value" id="stat-paters">0</div><div class="stat-label">Pai Nossos</div></div>
    </div>
    <button class="btn-home" onclick="app.home()">Voltar ao Início</button>
</div>
<button class="audio-toggle" id="audio-toggle" onclick="app.toggleAudio()" title="Ativar/Desativar sons (M)">
    <svg id="audio-icon-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="display:none;">
        <path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
    </svg>
    <svg id="audio-icon-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>
    </svg>
</button>
<script type="module">
import { firebaseConfig } from './config.js';
import{ initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import{ getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import{ getDatabase, ref, set, get, update, remove, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js'; // Adicionado push
const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const database = getDatabase(firebaseApp);

let currentFriendUid = null; // Guarda o ID do amigo que estamos visitando

window.getAvatarHTML = function(avatarValue, size = '100%') {
    if (!avatarValue) return '👤';
    if (avatarValue.indexOf('.') > -1) {
        return `<img src="img/avatars/${avatarValue}" class="avatar-img" alt="Avatar" style="width:${size}; height:${size}; object-fit: cover;">`;
    }
    return `<div style="display:flex; align-items:center; justify-content:center; width:100%; height:100%; font-size: calc(${size} * 0.6);">${avatarValue}</div>`;
}

function usernameToEmail(username){
    return username.toLowerCase().replace(/\s+/g, '') + '@rosario.app';
}
function getFirebaseErrorMessage(errorCode){
    const errors ={
        'auth/email-already-in-use': 'Este nome de usuário já está em uso!',
        'auth/invalid-email': 'Nome de usuário inválido!',
        'auth/operation-not-allowed': 'Operação não permitida!',
        'auth/weak-password': 'Senha muito fraca! Use no mínimo 6 caracteres.',
        'auth/user-disabled': 'Usuário desabilitado!',
        'auth/user-not-found': 'Usuário não encontrado!',
        'auth/wrong-password': 'Senha incorreta!',
        'auth/invalid-credential': 'Credenciais inválidas! Verifique seu usuário e senha.',
        'auth/too-many-requests': 'Muitas tentativas. Aguarde um momento e tente novamente.'
    };
    return errors[errorCode] || 'Erro ao processar solicitação. Tente novamente.';
}
function showElement(id){ document.getElementById(id).classList.add('visible');}
function hideElement(id){ document.getElementById(id).classList.remove('visible');}
function showError(id, message){
    const el = document.getElementById(id);
    el.textContent = message;
    showElement(id);
    setTimeout(() => hideElement(id), 5000);
}
function showSuccess(id, message){
    const el = document.getElementById(id);
    el.textContent = message;
    showElement(id);
}
function setButtonLoading(btnId, isLoading){
    const btn = document.getElementById(btnId);
    btn.disabled = isLoading;
    if (isLoading) btn.innerHTML = '<span class="loading"></span>';
}
// Autenticação
async function registerUser(username, displayName, password){
    try{
        setButtonLoading('register-btn', true);
        const email = usernameToEmail(username);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await set(ref(database, 'users/' + user.uid),{
            username: username,
            displayName: displayName,
            avatar: 'therese.png',
            createdAt: new Date().toISOString(),
            prayedDays:{},
            totalRosaries: 0,
            totalAves: 0,
            totalPaters: 0,
            currentStreak: 0,
            longestStreak: 0
        });
        showSuccess('register-success', 'Conta criada com sucesso! Entrando...');
        setTimeout(() =>{
            document.getElementById('register-form').reset();
            hideElement('register-success');
        }, 2000);
    } catch (error){
        console.error('Erro no registro:', error);
        showError('register-error', getFirebaseErrorMessage(error.code));
    } finally{
        setButtonLoading('register-btn', false);
        document.getElementById('register-btn').textContent = 'Criar Conta';
    }
}
async function loginUser(username, password){
    try{
        setButtonLoading('login-btn', true);
        const email = usernameToEmail(username);
        await signInWithEmailAndPassword(auth, email, password);
    } catch (error){
        console.error('Erro no login:', error);
        showError('login-error', getFirebaseErrorMessage(error.code));
        setButtonLoading('login-btn', false);
        document.getElementById('login-btn').textContent = 'Entrar';
    }
}
async function logoutUser(){
    // NOVO: Usa o modal personalizado em vez de confirm()
    showConfirm('Sair', 'Deseja realmente sair da conta?', async (confirmed) => {
        if (confirmed) {
            try{
                await signOut(auth);
                document.querySelectorAll('.input-field').forEach(f => f.value = '');
            } catch (error){
                console.error('Erro ao sair:', error);
                showCustomAlert('Erro', 'Erro ao sair da conta. Tente novamente.');
            }
        }
    });
}
// Auth State Observer
onAuthStateChanged(auth, async (user) =>{
    if (user){
        setButtonLoading('login-btn', false);
        document.getElementById('login-btn').textContent = 'Entrar';
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        // Carregar dados do usuário
        const userRef = ref(database, 'users/' + user.uid);
        const snapshot = await get(userRef);
        if (snapshot.exists()){
            window.userProfile = snapshot.val();
            window.currentUser = user;
            // Atualizar UI
            updateUserInterface();
            // Carregar Amigos e Pedidos se estiver na aba
            if (document.getElementById('tab-friends').classList.contains('active')) {
                loadFriends();
                loadFriendRequests();
            }
        }
    } else{
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
        window.userProfile = null;
        window.currentUser = null;
    }
});
// Atualizar interface com dados do usuário
function updateUserInterface(){
    const profile = window.userProfile;
    if (!profile) return;
    const displayName = profile.displayName || profile.username;
    const initial = displayName.charAt(0).toUpperCase();
    const avatar = profile.avatar || initial;
    
    document.getElementById('home-user-name').textContent = displayName;
    document.getElementById('profile-name').textContent = displayName;
    document.getElementById('profile-handle').textContent = '@' + profile.username; // MOSTRA HANDLE
    document.getElementById('profile-avatar').innerHTML = window.getAvatarHTML(avatar);
    
    // NOVOS CAMPOS: Preencher Bio e Intenção se existirem
    document.getElementById('profile-bio').value = profile.bio || '';
    document.getElementById('profile-intention').value = profile.intention || '';

    const streak = profile.currentStreak || 0;
    const streakMessage = streak === 0 ? 'Comece hoje sua jornada de oração' :
                          streak === 1 ? 'Continue orando! Você começou bem!' :
                          streak < 7 ? 'Ótimo progresso! Continue assim!' :
                          streak < 30 ? 'Parabéns! Você está firme na fé!' :
                          'Incrível! Que exemplo de perseverança!';
    document.getElementById('home-streak-count').textContent = streak;
    document.getElementById('home-streak-message').textContent = streakMessage;
    document.getElementById('profile-streak-count').textContent = streak;
    document.getElementById('profile-streak-message').textContent = streakMessage;

    document.getElementById('profile-total-rosaries').textContent = profile.totalRosaries || 0;
    document.getElementById('profile-longest-streak').textContent = profile.longestStreak || 0;
    document.getElementById('profile-total-aves').textContent = profile.totalAves || 0;
    document.getElementById('profile-total-paters').textContent = profile.totalPaters || 0;
    
    // ATUALIZAR BARRA DE DESAFIO NO MEU PERFIL (Se existir)
    if (profile.active_challenge) {
        document.getElementById('my-challenge-progress').style.display = 'block';
        const c = profile.active_challenge;
        document.getElementById('my-challenge-p1').textContent = "Eu";
        document.getElementById('my-challenge-p1-count').textContent = c.my_progress + "/7";
        document.getElementById('my-challenge-p1-fill').style.width = (c.my_progress / 7 * 100) + "%";
        
        document.getElementById('my-challenge-p2').textContent = c.friend_name;
        document.getElementById('my-challenge-p2-count').textContent = c.friend_progress + "/7";
        document.getElementById('my-challenge-p2-fill').style.width = (c.friend_progress / 7 * 100) + "%";
    } else {
        document.getElementById('my-challenge-progress').style.display = 'none';
    }

    const intentions = [
        "Pelos que sofrem perseguição por causa da fé.",
        "Pela conversão dos pecadores e a salvação das almas.",
        "Pelas vocações sacerdotais e religiosas.",
        "Pela paz no mundo e o fim das guerras.",
        "Pelos enfermos e todos que cuidam deles.",
        "Pelas almas do purgatório, especialmente as mais abandonadas.",
        "Pela santificação das famílias.",
        "Pelos jovens, para que encontrem seu caminho em Cristo.",
        "Pela Igreja e pelo Santo Padre.",
        "Pelos missionários em terras distantes.",
    ];
    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    const intention = intentions[dayOfYear % intentions.length];
    document.getElementById('home-intention').textContent = intention;
    document.getElementById('calendar-intention').textContent = intention;
    const days = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
    const today = new Date();
    document.getElementById('home-today-day').textContent = days[today.getDay()];
    document.getElementById('rosary-today-day').textContent = days[today.getDay()];
    const dayMap ={ 0: 'Gloriosos', 1: 'Gozosos', 2: 'Dolorosos', 3: 'Gloriosos', 4: 'Gozosos', 5: 'Dolorosos', 6: 'Gozosos' };
    document.getElementById('home-today-mystery').textContent = 'Mistérios ' + dayMap[today.getDay()];
    document.getElementById('rosary-today-mystery').textContent = 'Mistérios ' + dayMap[today.getDay()];
    renderCalendar();
    checkInbox(); // Atualiza a badge do inbox
}
// Estado do calendário
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();
// Renderizar Calendário
function renderCalendar(){
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    document.getElementById('calendar-month-year').textContent = 
        `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
    const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    for (let i = 0; i < firstDay; i++){
        const emptyDay = document.createElement('div');
        emptyDay.style.cssText = 'height: 40px;';
        grid.appendChild(emptyDay);
    }
    const today = new Date();
    const isCurrentMonth = currentCalendarMonth === today.getMonth() && 
                           currentCalendarYear === today.getFullYear();
    const prayedDays = window.userProfile?.prayedDays ||{};
    for (let day = 1; day <= daysInMonth; day++){
        // CORREÇÃO DATA: Força 2 dígitos
        const dateKey = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasPrayed = prayedDays[dateKey] === true;
        const isToday = isCurrentMonth && day === today.getDate();
        const dayEl = document.createElement('div');
        dayEl.textContent = day;
        dayEl.style.cssText = `
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-family: var(--font-body);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            ${hasPrayed ? `
                background: var(--gold);
                color: var(--bg-deep);
                font-weight: 600;
                box-shadow: 0 0 12px var(--gold-glow);
            ` : `
                color: var(--text-secondary);
                border: 1px solid var(--border-subtle);
            `}
            ${isToday ? `
                border: 2px solid var(--gold);
                ${!hasPrayed ? 'color: var(--gold);' : ''}
            ` : ''}
        `;
        dayEl.onmouseover = () =>{
            if (!hasPrayed){
                dayEl.style.borderColor = 'var(--gold-dim)';
                dayEl.style.color = 'var(--gold)';
            }
        };
        dayEl.onmouseout = () =>{
            if (!hasPrayed){
                dayEl.style.borderColor = 'var(--border-subtle)';
                dayEl.style.color = 'var(--text-secondary)';
                if (isToday){
                    dayEl.style.borderColor = 'var(--gold)';
                    dayEl.style.color = 'var(--gold)';
                }
            }
        };
        grid.appendChild(dayEl);
    }
}

// ==========================================
// ===== LÓGICA DE AMIGOS (INTEGRADA) =====
// ==========================================

async function searchFriend() {
    const input = document.getElementById('friend-search-input');
    const resultDiv = document.getElementById('search-result');
    let searchTerm = input.value.trim().toLowerCase();
    
    searchTerm = searchTerm.replace(/^@/, '');
    
    if (!searchTerm || searchTerm.length < 2) {
        resultDiv.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem; padding: 8px;">Digite pelo menos 2 caracteres</p>';
        return;
    }
    
    resultDiv.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem; padding: 8px;">Buscando...</p>';
    
    try {
        const usersRef = ref(database, 'users');
        const snapshot = await get(usersRef);
        
        if (!snapshot.exists()) {
            resultDiv.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem; padding: 8px;">Nenhum usuário encontrado</p>';
            return;
        }
        
        const users = snapshot.val();
        let results = [];
        
        // CORREÇÃO: BUSCA INTELIGENTE (INCLUDES)
        for (const uid in users) {
            const u = users[uid];
            if (uid === window.currentUser.uid) continue; // Pula eu mesmo

            if (u.username.toLowerCase().includes(searchTerm) || 
                (u.displayName && u.displayName.toLowerCase().includes(searchTerm))) {
                results.push({uid, ...u});
            }
        }
        
        if (results.length === 0) {
            resultDiv.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem; padding: 8px;">Nenhum usuário encontrado</p>';
            return;
        }

        // Mostra o primeiro resultado (ou lista, mas vamos focar no primeiro para simplificar layout mobile)
        const found = results[0]; 
        const foundUid = found.uid;
        
        const myFriendsRef = ref(database, `users/${window.currentUser.uid}/friends/${foundUid}`);
        const friendCheck = await get(myFriendsRef);
        
        if (friendCheck.exists()) {
            resultDiv.innerHTML = `
                <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; border: 1px solid var(--gold); background: var(--bg-deep); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">${window.getAvatarHTML(found.avatar)}</div>
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-display); font-size: 0.95rem; color: var(--text-primary);">${found.displayName || found.username}</div>
                        <div style="font-family: var(--font-body); font-size: 0.85rem; color: var(--gold);">@${found.username}</div>
                        <div style="font-family: var(--font-body); font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">✅ Já são amigos</div>
                    </div>
                </div>
            `;
            return;
        }
        
        const sentRef = ref(database, `friend_requests/${window.currentUser.uid}/sent/${foundUid}`);
        const sentCheck = await get(sentRef);
        
        if (sentCheck.exists()) {
            resultDiv.innerHTML = `
                <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; border: 1px solid var(--gold); background: var(--bg-deep); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">${window.getAvatarHTML(found.avatar)}</div>
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-display); font-size: 0.95rem; color: var(--text-primary);">${found.displayName || found.username}</div>
                        <div style="font-family: var(--font-body); font-size: 0.85rem; color: var(--gold);">@${found.username}</div>
                        <div style="font-family: var(--font-body); font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">⏳ Pedido enviado</div>
                    </div>
                </div>
            `;
            return;
        }
        
        resultDiv.innerHTML = `
            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; border: 1px solid var(--gold); background: var(--bg-deep); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">${window.getAvatarHTML(found.avatar)}</div>
                <div style="flex: 1;">
                    <div style="font-family: var(--font-display); font-size: 0.95rem; color: var(--text-primary);">${found.displayName || found.username}</div>
                    <div style="font-family: var(--font-body); font-size: 0.85rem; color: var(--gold);">@${found.username}</div>
                    <div style="font-family: var(--font-body); font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">🔥 ${found.currentStreak || 0} dias</div>
                </div>
                <button onclick="sendFriendRequest('${foundUid}')" style="padding: 10px 18px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%); border: none; border-radius: 6px; color: var(--bg-deep); font-family: var(--font-display); font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer;">Adicionar</button>
            </div>
        `;
        
    } catch (error) {
        console.error('Erro:', error);
        resultDiv.innerHTML = '<p style="color: #c07070; font-size: 0.85rem; padding: 8px;">Erro ao buscar: ' + error.message + '</p>';
    }
}

async function sendFriendRequest(targetUid) {
    // NOVO: Alerta personalizado
    showConfirm('Adicionar Amigo', 'Enviar pedido de amizade?', async (confirmed) => {
        if (!confirmed) return;
        
        try {
            const updates = {};
            updates[`friend_requests/${targetUid}/received/${window.currentUser.uid}`] = Date.now();
            updates[`friend_requests/${window.currentUser.uid}/sent/${targetUid}`] = Date.now();
            
            const { getDatabase, ref, update } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            const database = getDatabase();
            
            await update(ref(database), updates);
            showCustomAlert('Pedido Enviado! ✨', 'Aguarde a confirmação do seu amigo.');
            document.getElementById('friend-search-input').value = '';
            document.getElementById('search-result').innerHTML = '';
        } catch (error) {
            console.error('Erro:', error);
            showCustomAlert('Erro', 'Não foi possível enviar o pedido. Tente novamente.');
        }
    });
}

async function loadFriendRequests() {
    try {
        const requestsRef = ref(database, `friend_requests/${window.currentUser.uid}/received`);
        const snapshot = await get(requestsRef);
        const section = document.getElementById('friend-requests-section');
        const list = document.getElementById('friend-requests-list');
        
        if (!snapshot.exists()) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        list.innerHTML = '';
        const requests = snapshot.val();
        
        for (const uid in requests) {
            const userRef = ref(database, `users/${uid}`);
            const userSnap = await get(userRef);
            if (userSnap.exists()) {
                const user = userSnap.val();
                const card = document.createElement('div');
                card.style.cssText = 'background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px;';
                card.innerHTML = `
                    <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; border: 1px solid var(--gold); background: var(--bg-deep); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">${window.getAvatarHTML(user.avatar)}</div>
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-display); font-size: 0.95rem; color: var(--text-primary);">${user.displayName || user.username}</div>
                        <div style="font-family: var(--font-body); font-size: 0.85rem; color: var(--gold);">@${user.username}</div>
                    </div>
                    <button onclick="acceptFriendRequest('${uid}')" style="padding: 8px 16px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%); border: none; border-radius: 6px; color: var(--bg-deep); font-family: var(--font-display); font-size: 0.7rem; text-transform: uppercase; cursor: pointer; margin-right: 8px;">Aceitar</button>
                    <button onclick="rejectFriendRequest('${uid}')" style="padding: 8px 16px; background: rgba(180, 60, 60, 0.15); border: 1px solid rgba(180, 60, 60, 0.3); border-radius: 6px; color: #c07070; font-family: var(--font-display); font-size: 0.7rem; text-transform: uppercase; cursor: pointer;">Recusar</button>
                `;
                list.appendChild(card);
            }
        }
    } catch (error) {
        console.error('Erro:', error);
    }
}

async function acceptFriendRequest(friendUid) {
    try {
        const updates = {};
        updates[`users/${window.currentUser.uid}/friends/${friendUid}`] = Date.now();
        updates[`users/${friendUid}/friends/${window.currentUser.uid}`] = Date.now();
        await update(ref(database), updates);
        await remove(ref(database, `friend_requests/${window.currentUser.uid}/received/${friendUid}`));
        await remove(ref(database, `friend_requests/${friendUid}/sent/${window.currentUser.uid}`));
        showCustomAlert('Amizade Confirmada! 🎉', 'Agora vocês são amigos no Rosário.');
        loadFriendRequests();
        loadFriends();
    } catch (error) {
        console.error('Erro:', error);
        showCustomAlert('Erro', 'Não foi possível aceitar o pedido.');
    }
}
async function rejectFriendRequest(friendUid) {
    try {
        await remove(ref(database, `friend_requests/${window.currentUser.uid}/received/${friendUid}`));
        await remove(ref(database, `friend_requests/${friendUid}/sent/${window.currentUser.uid}`));
        loadFriendRequests();
    } catch (error) {
        console.error('Erro:', error);
    }
}

async function loadFriends() {
    try {
        const friendsRef = ref(database, `users/${window.currentUser.uid}/friends`);
        const snapshot = await get(friendsRef);
        const list = document.getElementById('friends-list');
        
        if (!snapshot.exists()) {
            list.innerHTML = '<p style="font-family: var(--font-body); font-size: 0.95rem; color: var(--text-dim); font-style: italic; text-align: center; padding: 40px 20px;">Você ainda não tem amigos. Use a busca acima!</p>';
            return;
        }
        
        list.innerHTML = '';
        const friends = snapshot.val();
        
        for (const uid in friends) {
            const userRef = ref(database, `users/${uid}`);
            const userSnap = await get(userRef);
            if (userSnap.exists()) {
                const user = userSnap.val();
                const card = document.createElement('div');
                card.style.cssText = 'background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;';
                card.onmouseover = () => { card.style.borderColor = 'var(--gold-dim)'; card.style.transform = 'translateY(-2px)'; };
                card.onmouseout = () => { card.style.borderColor = 'var(--border-subtle)'; card.style.transform = 'translateY(0)'; };
                
                card.onclick = () => viewFriendProfile(uid, user);
                
                card.innerHTML = `
                    <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; border: 1px solid var(--gold); background: var(--bg-deep); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">${window.getAvatarHTML(user.avatar)}</div>
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-display); font-size: 0.95rem; color: var(--text-primary);">${user.displayName || user.username}</div>
                        <div style="font-family: var(--font-body); font-size: 0.85rem; color: var(--gold);">@${user.username}</div>
                        <div style="font-family: var(--font-body); font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">🔥 ${user.currentStreak || 0} dias</div>
                    </div>
                    <svg style="width: 20px; height: 20px; color: var(--text-dim);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                `;
                list.appendChild(card);
            }
        }
    } catch (error) {
        console.error('Erro:', error);
    }
}

function viewFriendProfile(uid, user) {
    currentFriendUid = uid; // GUARDA O ID DO AMIGO PARA REZAR
    document.getElementById('friends-main-view').style.display = 'none';
    const profileView = document.getElementById('friend-profile-view');
    profileView.style.display = 'block';
    
    document.getElementById('fp-avatar-container').innerHTML = window.getAvatarHTML(user.avatar, '100%');
    document.getElementById('fp-name').textContent = user.displayName || user.username;
    document.getElementById('fp-username').textContent = '@' + user.username;
    document.getElementById('fp-streak').textContent = user.currentStreak || 0;
    document.getElementById('fp-rosaries').textContent = user.totalRosaries || 0;

    // MOSTRAR BIO E INTENÇÃO DO AMIGO
    const bioSection = document.getElementById('fp-bio-section');
    const bioText = document.getElementById('fp-bio');
    const intentionSection = document.getElementById('fp-intention-section');
    const intentionText = document.getElementById('fp-intention');

    if (user.bio && user.bio.trim() !== '') {
        bioText.textContent = user.bio;
        bioSection.style.display = 'block';
    } else {
        bioSection.style.display = 'none';
    }

    if (user.intention && user.intention.trim() !== '') {
        intentionText.textContent = user.intention;
        intentionSection.style.display = 'block';
    } else {
        intentionSection.style.display = 'none';
    }
    
    // MOSTRAR BARRA DE DESAFIO NO PERFIL DO AMIGO (SE HOUVER)
    if (user.active_challenge && user.active_challenge.friend_uid === window.currentUser.uid) {
         document.getElementById('fp-challenge-progress').style.display = 'block';
         const c = user.active_challenge;
         
         // Inverte as barras pq aqui estamos vendo do ponto de vista do amigo
         document.getElementById('challenge-p1-name').textContent = "Ele";
         document.getElementById('challenge-p1-count').textContent = c.my_progress + "/7";
         document.getElementById('challenge-p1-fill').style.width = (c.my_progress / 7 * 100) + "%";

         document.getElementById('challenge-p2-name').textContent = "Você";
         document.getElementById('challenge-p2-count').textContent = c.friend_progress + "/7";
         document.getElementById('challenge-p2-fill').style.width = (c.friend_progress / 7 * 100) + "%";
         
         // Esconde botão de desafiar se já tem desafio
         document.getElementById('btn-challenge-friend').style.display = 'none';
    } else {
         document.getElementById('fp-challenge-progress').style.display = 'none';
         document.getElementById('btn-challenge-friend').style.display = 'flex';
    }
}

window.backToFriendsList = function() {
    document.getElementById('friend-profile-view').style.display = 'none';
    document.getElementById('friends-main-view').style.display = 'block';
}

// ===== SISTEMA DE INBOX E DESAFIOS =====

// 1. Checar se tem mensagens (Apenas para atualizar o ícone/badge)
window.checkInbox = async function() {
    if (!window.currentUser) return;
    try {
        const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
        const database = getDatabase();
        const inboxRef = ref(database, `inbox/${window.currentUser.uid}`);
        const snapshot = await get(inboxRef);

        const badge = document.getElementById('inbox-badge');
        
        if (snapshot.exists()) {
            badge.style.display = 'block'; // Mostra a bolinha vermelha
        } else {
            badge.style.display = 'none';
        }
    } catch (e) { console.error(e); }
};

// 2. Abrir Modal e Carregar Mensagens
window.openInboxModal = async function() {
    document.getElementById('inbox-modal').classList.add('active');
    const list = document.getElementById('inbox-list');
    list.innerHTML = '<div class="loading" style="margin: 20px auto; display:block;"></div>'; // Loading spinner

    if (!window.currentUser) {
        list.innerHTML = '<div class="empty-inbox">Entre na sua conta para ver mensagens.</div>';
        return;
    }

    try {
        const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
        const database = getDatabase();
        const inboxRef = ref(database, `inbox/${window.currentUser.uid}`);
        const snapshot = await get(inboxRef);

        list.innerHTML = ''; // Limpa loading

        if (!snapshot.exists()) {
            list.innerHTML = `
                <div class="empty-inbox">
                    <div style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;">📭</div>
                    Sua caixa de entrada está vazia.
                </div>`;
            return;
        }

        const msgs = snapshot.val();
        // Converte objeto em array e inverte (mais recente primeiro)
        const msgArray = Object.entries(msgs).sort((a, b) => b[1].timestamp - a[1].timestamp);

        msgArray.forEach(([key, data]) => {
            const date = new Date(data.timestamp);
            const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            
            const div = document.createElement('div');
            div.className = 'inbox-card';
            
            if (data.type === 'prayer') {
                div.innerHTML = `
                    <div class="inbox-header">
                        <strong style="color: var(--gold); font-family: var(--font-display); font-size: 0.8rem;">${data.fromName}</strong>
                        <span class="inbox-time">${dateStr}</span>
                    </div>
                    <div class="inbox-body">
                        🙏 Rezou pela sua intenção!
                    </div>
                    <div style="text-align: right; margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 6px;">
                        <button class="btn-delete-msg" onclick="deleteMessage('${key}')">Apagar</button>
                    </div>
                `;
            } else if (data.type === 'challenge') {
                div.innerHTML = `
                    <div class="inbox-header">
                        <strong style="color: var(--gold); font-family: var(--font-display); font-size: 0.8rem;">${data.fromName}</strong>
                        <span class="inbox-time">${dateStr}</span>
                    </div>
                    <div class="inbox-body" style="margin-bottom: 12px;">
                        ⚔️ Desafiou você para 7 dias de oração!
                    </div>
                    <div class="challenge-actions">
                        <button class="btn-challenge-accept" onclick="acceptChallenge('${key}', '${data.fromUid}', '${data.fromName}')">Aceitar Desafio</button>
                        <button class="btn-delete-msg" onclick="deleteMessage('${key}')">Recusar</button>
                    </div>
                `;
            }
            list.appendChild(div);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<div class="empty-inbox">Erro ao carregar mensagens.</div>';
    }
};

window.closeInboxModal = function() {
    document.getElementById('inbox-modal').classList.remove('active');
    // Atualiza o badge ao fechar, caso tenha apagado tudo
    window.checkInbox();
};

// 3. Apagar Mensagem Individual
window.deleteMessage = async function(key) {
    showConfirm('Apagar', 'Apagar esta notificação?', async (confirmed) => {
        if (!confirmed) return;
        const btn = event.target;
        const card = btn.closest('.inbox-card');
        card.style.opacity = '0';
        setTimeout(() => card.remove(), 300);

        try {
            const { getDatabase, ref, remove } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            const database = getDatabase();
            await remove(ref(database, `inbox/${window.currentUser.uid}/${key}`));
        } catch(e) { console.error(e); }
    });
};

// 4. ENVIAR ORAÇÃO
window.sendPrayerToFriend = async function() {
    if (!currentFriendUid || !window.currentUser) return;
    
    const btn = document.getElementById('btn-pray-friend');
    const originalContent = btn.innerHTML;
    
    btn.innerHTML = '<span style="color:white;">Enviando...</span>';
    btn.disabled = true;

    try {
        const { getDatabase, ref, push } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
        const database = getDatabase();
        
        await push(ref(database, `inbox/${currentFriendUid}`), {
            type: 'prayer',
            fromName: window.userProfile.displayName || window.userProfile.username,
            timestamp: Date.now()
        });

        showCustomAlert('Oração Enviada', 'Seu amigo será notificado.');
        btn.innerHTML = '<span>✨ Enviado!</span>';
        
    } catch (error) {
        console.error(error);
        showCustomAlert('Erro', 'Não foi possível enviar.');
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
};

// 5. ENVIAR DESAFIO (Convite)
window.sendChallengeToFriend = async function() {
    if (!currentFriendUid || !window.currentUser) return;
    
    // NOVO: Usando o alerta bonito
    showConfirm('Desafio', 'Enviar desafio de 7 dias para este amigo?', async (confirmed) => {
        if (!confirmed) return;
        
        try {
            const { getDatabase, ref, push } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            const database = getDatabase();
            
            await push(ref(database, `inbox/${currentFriendUid}`), {
                type: 'challenge',
                fromName: window.userProfile.displayName || window.userProfile.username,
                fromUid: window.currentUser.uid,
                timestamp: Date.now()
            });

            showCustomAlert('Desafio Enviado!', 'Aguarde seu amigo aceitar.');
            
        } catch (error) {
            showCustomAlert('Erro', 'Não foi possível enviar o desafio.');
        }
    });
};

// 6. ACEITAR DESAFIO
window.acceptChallenge = async function(msgKey, fromUid, fromName) {
    try {
        const { getDatabase, ref, update, remove } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
        const database = getDatabase();
        const myUid = window.currentUser.uid;
        const myName = window.userProfile.displayName || window.userProfile.username;

        // Cria o objeto do desafio (igual para os dois)
        const challengeData = {
            active: true,
            start_date: Date.now(),
            my_progress: 0,
            friend_progress: 0,
            friend_uid: fromUid,
            friend_name: fromName
        };
        
        const reverseChallengeData = {
            active: true,
            start_date: Date.now(),
            my_progress: 0,
            friend_progress: 0,
            friend_uid: myUid,
            friend_name: myName
        };

        const updates = {};
        // Grava no meu perfil
        updates[`users/${myUid}/active_challenge`] = challengeData;
        // Grava no perfil do amigo
        updates[`users/${fromUid}/active_challenge`] = reverseChallengeData;
        // Remove o convite da inbox
        updates[`inbox/${myUid}/${msgKey}`] = null;

        await update(ref(database), updates);
        
        closeInboxModal();
        showCustomAlert('Desafio Aceito!', 'A guerra começou! Reze todos os dias.');
        window.location.reload(); // Recarrega para mostrar a barra
        
    } catch (e) {
        console.error(e);
        showCustomAlert('Erro', 'Falha ao aceitar desafio.');
    }
};

document.addEventListener('DOMContentLoaded', () =>{
    document.querySelectorAll('.auth-tab').forEach(tab =>{
        tab.addEventListener('click', () =>{
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '-form').classList.add('active');
        });
    });
document.getElementById('login-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    loginUser(username, password);
});
document.getElementById('register-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const username = document.getElementById('register-username').value.trim();
    const displayName = document.getElementById('register-displayname').value.trim();
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('register-confirm').value;
    
    if (password !== confirm) {
        showError('register-error', 'As senhas não coincidem!');
        return;
    }
    
    if (username.length < 3) {
        showError('register-error', 'Nome de usuário muito curto! Use no mínimo 3 caracteres.');
        return;
    }
    
    registerUser(username, displayName, password);
});
    document.querySelectorAll('.nav-item[data-tab]').forEach(btn =>{
        btn.addEventListener('click', () =>{
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            
            if (btn.dataset.tab === 'friends' && window.currentUser) {
                backToFriendsList();
                loadFriends();
                loadFriendRequests();
            }
        });
    });
    document.getElementById('nav-rosary-btn').addEventListener('click', () =>{
        document.querySelector('.nav-item[data-tab="rosary"]').click();
    });
    document.getElementById('prev-month-btn').addEventListener('click', () =>{
        currentCalendarMonth--;
        if (currentCalendarMonth < 0){
            currentCalendarMonth = 11;
            currentCalendarYear--;
        }
        renderCalendar();
    });
    document.getElementById('next-month-btn').addEventListener('click', () =>{
        currentCalendarMonth++;
        if (currentCalendarMonth > 11){
            currentCalendarMonth = 0;
            currentCalendarYear++;
        }
        renderCalendar();
    });

    const searchInput = document.getElementById('friend-search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchFriend();
        });
    }
});
window.firebaseAuth ={ logoutUser };
window.updateUserInterface = updateUserInterface;
window.renderCalendar = renderCalendar;
window.searchFriend = searchFriend;
window.sendFriendRequest = sendFriendRequest;
window.acceptFriendRequest = acceptFriendRequest;
window.rejectFriendRequest = rejectFriendRequest;
window.viewFriendProfile = viewFriendProfile;
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('✅ Service Worker registrado:', registration.scope);
        
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('🔄 Nova versão disponível!');
              if (confirm('Nova versão disponível! Atualizar agora?')) {
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(error => {
        console.error('❌ Erro ao registrar Service Worker:', error);
      });
  });
}
function showCustomAlert(title, message) {
    document.getElementById('alert-title').textContent = title;
    document.getElementById('alert-message').textContent = message;
    document.getElementById('custom-alert').classList.add('active');
}

function closeCustomAlert() {
    document.getElementById('custom-alert').classList.remove('active');
}

// NOVA FUNÇÃO: Confirm Modal (Substitui o window.confirm feio)
window.confirmCallback = null;

function showConfirm(title, message, callback) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-modal').classList.add('active');
    window.confirmCallback = callback;
}

function resolveConfirm(result) {
    document.getElementById('confirm-modal').classList.remove('active');
    if (window.confirmCallback) {
        window.confirmCallback(result);
        window.confirmCallback = null;
    }
}

// Global window exposure
window.showConfirm = showConfirm;
window.resolveConfirm = resolveConfirm;

// Fechar ao clicar fora (cuidado para não fechar o confirm sem querer)
document.addEventListener('click', (e) => {
    const alertModal = document.getElementById('custom-alert');
    if (e.target === alertModal) closeCustomAlert();
});

window.showCustomAlert = showCustomAlert;
window.closeCustomAlert = closeCustomAlert;
</script>
</body>
</html>
