<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Santo Ros√°rio ¬∑ M√©todo Montfort</title>
    
    <link rel="icon" type="image/x-icon" href="/rosario-tradicional/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/rosario-tradicional/icon-192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/rosario-tradicional/icon-192.png">
    
    <meta name="description" content="Reze o Santo Ros√°rio pelo M√©todo de S√£o Lu√≠s de Montfort. App completo com medita√ß√µes, calend√°rio e acompanhamento.">
    <meta name="theme-color" content="#080709">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ros√°rio">
    <link rel="manifest" href="/rosario-tradicional/manifest.json">
    <link rel="apple-touch-icon" href="/rosario-tradicional/icon-192.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg-deep: #080709; --bg-primary: #0d0b0e; --bg-secondary: #151316; --bg-elevated: #1d1a1f; --bg-card: #1a171c;
            --text-primary: #f4f1eb; --text-secondary: #c2b8aa; --text-muted: #7d7470; --text-dim: #4d4845;
            --gold: #d4a855; --gold-bright: #f5d680; --gold-light: #e8c45a; --gold-dim: #a58540; --gold-dark: #6a5225; --gold-glow: rgba(212, 168, 85, 0.5);
            --burgundy: #6b2d3d; --burgundy-light: #8a3d50; --burgundy-bright: #a04d62; --burgundy-glow: rgba(138, 61, 80, 0.5);
            --cream: #faf5e8; --border-subtle: rgba(212, 168, 85, 0.1); --border-gold: rgba(212, 168, 85, 0.25);
            --font-display: 'Cinzel', serif; --font-body: 'Cormorant Garamond', serif;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1); --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --bead-size: 48px; --bead-size-small: 36px; --bead-size-pater: 56px; --bead-gap: 20px; --rail-width: 110px;
        }
        *{ box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent;}
        html, body{ height: 100%; overflow: hidden;}
        body{ background: var(--bg-deep); color: var(--text-primary); font-family: var(--font-body); font-size: 18px; line-height: 1.6; }
        body::before{ content: ''; position: fixed; inset: 0; background: radial-gradient(ellipse at 15% 15%, rgba(107, 45, 61, 0.12) 0%, transparent 45%), radial-gradient(ellipse at 85% 85%, rgba(212, 168, 85, 0.08) 0%, transparent 45%), radial-gradient(ellipse at 50% 50%, rgba(20, 18, 22, 0.5) 0%, transparent 100%); pointer-events: none; z-index: 0; }

        /* Auth */
        #auth-screen{ position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 28px; padding-top: 60px; overflow-y: auto; overflow-x: hidden; z-index: 200; transition: opacity 0.6s var(--ease-out), visibility 0.6s; }
        #auth-screen.hidden{ opacity: 0; visibility: hidden; pointer-events: none;}
        .auth-container{ width: 100%; max-width: 380px; text-align: center;}
        .auth-logo{ width: 50px; height: 70px; position: relative; margin: 0 auto 24px;}
        .auth-logo::before, .auth-logo::after{ content: ''; position: absolute; background: linear-gradient(180deg, var(--gold-bright) 0%, var(--gold) 50%, var(--gold-dim) 100%); border-radius: 2px; }
        .auth-logo::before{ width: 4px; height: 100%; left: 50%; transform: translateX(-50%);}
        .auth-logo::after{ width: 40px; height: 4px; top: 20px; left: 50%; transform: translateX(-50%);}
        .auth-title{ font-family: var(--font-display); font-size: 1.8rem; font-weight: 500; letter-spacing: 0.2em; color: var(--text-primary); margin-bottom: 6px; }
        .auth-subtitle{ font-family: var(--font-body); font-size: 1rem; font-style: italic; color: var(--text-muted); margin-bottom: 20px; }
        .auth-info{ background: rgba(212, 168, 85, 0.1); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; margin-bottom: 24px; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; }
        .auth-tabs{ display: flex; margin-bottom: 28px; border-bottom: 1px solid var(--border-subtle);}
        .auth-tab{ flex: 1; padding: 14px; background: none; border: none; font-family: var(--font-display); font-size: 0.75rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); cursor: pointer; transition: all 0.3s; position: relative; }
        .auth-tab::after{ content: ''; position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background: var(--gold); transition: width 0.3s var(--ease-out); }
        .auth-tab.active{ color: var(--gold);}
        .auth-tab.active::after{ width: 60%;}
        .auth-form{ display: none;}
        .auth-form.active{ display: block;}
        .input-group{ margin-bottom: 18px; text-align: left;}
        .input-label{ display: block; font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; }
        .input-field{ width: 100%; padding: 14px 16px; background: #0f0d10; border: 1px solid var(--border-subtle); border-radius: 4px; font-family: var(--font-body); font-size: 1.05rem; color: var(--text-primary); transition: all 0.3s; }
        .input-field:focus{ outline: none; border-color: var(--gold-dim); box-shadow: 0 0 0 3px rgba(212, 168, 85, 0.1); }
        .auth-btn{ width: 100%; padding: 16px; margin-top: 8px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%); border: none; border-radius: 4px; font-family: var(--font-display); font-size: 0.85rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--bg-deep); cursor: pointer; transition: all 0.3s; }
        .auth-btn:hover{ transform: translateY(-2px); box-shadow: 0 8px 25px rgba(212, 168, 85, 0.3); }
        .auth-error, .auth-success{ margin-top: 16px; padding: 12px; border-radius: 4px; font-size: 0.9rem; display: none; }
        .auth-error{ background: rgba(180, 60, 60, 0.15); border: 1px solid rgba(180, 60, 60, 0.3); color: #e07070; }
        .auth-success{ background: rgba(74, 158, 107, 0.15); border: 1px solid rgba(74, 158, 107, 0.3); color: #70e070; }
        .auth-error.visible, .auth-success.visible{ display: block;}
        .loading{ display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(212, 168, 85, 0.3); border-radius: 50%; border-top-color: var(--gold); animation: spin 1s ease-in-out infinite; }
        
        /* Modal Avatar */
        #avatar-modal{ position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 300; padding: 24px; }
        #avatar-modal.active{ opacity: 1; visibility: visible; }
        .avatar-modal-content{ width: 100%; max-width: 420px; background: var(--bg-card); border: 1px solid var(--border-gold); border-radius: 16px; padding: 32px 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); position: relative; }
        .avatar-modal-close{ position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; background: none; border: none; color: var(--text-muted); cursor: pointer; transition: color 0.3s; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; line-height: 1; }
        .avatar-modal-close:hover{ color: var(--gold); }
        .avatar-modal-title{ font-family: var(--font-display); font-size: 1.1rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); text-align: center; margin-bottom: 28px; }
        
        /* Estilos de Avatar IMG */
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; }
        #profile-avatar { width: 90px; height: 90px; margin: 0 auto 16px; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(212, 168, 85, 0.2); font-size: 2.5rem; }
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .avatar-option { aspect-ratio: 1; background: rgba(255, 255, 255, 0.05); border: 2px solid var(--border-subtle); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; padding: 0; transition: all 0.3s; min-height: 60px; }
        .avatar-option:hover { border-color: var(--gold-dim); transform: scale(1.05); }
        .avatar-option.selected { border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); transform: scale(1.1); position: relative; }
        .avatar-option.selected::after { content: ''; position: absolute; inset: 0; border: 3px solid var(--gold); border-radius: 50%; }
        .avatar-save-btn{ width: 100%; padding: 16px; background: linear-gradient(135deg, var(--gold-dim) 0%, var(--gold) 100%); border: 1px solid var(--gold-light); border-radius: 8px; font-family: var(--font-display); font-size: 0.85rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--bg-deep); cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .avatar-save-btn:hover{ background: linear-gradient(135deg, var(--gold) 0%, var(--gold-bright) 100%); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(212, 168, 85, 0.4); }

        /* Layout */
        .home-screen-content{ overflow-y: auto; overflow-x: hidden; height: 100%; padding: 24px 24px 100px 24px; position: relative; }
        .tab-content{ display: none; width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; position: relative; }
        .tab-content.active{ display: block; }
        .tab-content::after, .home-screen-content::after{ content: ''; position: fixed; bottom: 70px; left: 0; right: 0; height: 60px; background: linear-gradient(to top, rgba(8, 7, 9, 1) 0%, rgba(8, 7, 9, 0.8) 50%, transparent 100%); pointer-events: none; z-index: 50; }
        #main-app{ position: fixed; inset: 0; display: flex; flex-direction: column; transition: opacity 0.6s var(--ease-out), visibility 0.6s; z-index: 100; }
        #main-app.hidden{ opacity: 0; visibility: hidden; pointer-events: none; }
        .app-content{ flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 70px; }
        .tab-content.active{ display: flex; flex-direction: column; }
        
        .bottom-nav{ position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-deep) 100%); border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 150; }
        .nav-item{ flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 0; background: none; border: none; cursor: pointer; transition: all 0.3s; position: relative; }
        .nav-icon{ width: 26px; height: 26px; color: var(--text-dim); transition: all 0.3s; margin-bottom: 4px; }
        .nav-label{ font-family: var(--font-display); font-size: 0.5rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-dim); transition: all 0.3s; }
        .nav-item.active .nav-icon{ color: var(--gold); filter: drop-shadow(0 0 8px var(--gold-glow)); }
        .nav-item.active .nav-label{ color: var(--gold); }
        .nav-item::before{ content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background: var(--gold); transition: width 0.3s var(--ease-out); }
        .nav-item.active::before{ width: 40px; }

        /* Estilos Gerais */
        .home-title{ font-family: var(--font-display); font-size: 2.2rem; font-weight: 500; letter-spacing: 0.25em; color: var(--text-primary); margin-bottom: 8px; text-shadow: 0 2px 20px rgba(0,0,0,0.5); }
        .home-subtitle{ font-family: var(--font-body); font-size: 1.1rem; font-style: italic; color: var(--text-muted); margin-bottom: 10px; }
        .btn-mystery{ background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); color: var(--text-secondary); padding: 22px 28px; font-family: var(--font-display); font-size: 1rem; font-weight: 400; letter-spacing: 0.18em; text-transform: uppercase; cursor: pointer; transition: all 0.5s var(--ease-smooth); position: relative; overflow: hidden; }
        .btn-mystery:hover{ border-color: var(--gold-dim); color: var(--gold); background: rgba(212, 168, 85, 0.06); transform: translateY(-4px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); }
        .btn-complete{ background: linear-gradient(135deg, rgba(107, 45, 61, 0.2) 0%, rgba(107, 45, 61, 0.08) 100%); border: 1px solid rgba(138, 61, 80, 0.35); color: var(--cream); padding: 24px 28px; margin-top: 4px; }
        .btn-complete small{ display: block; font-family: var(--font-body); font-size: 0.85rem; font-style: italic; font-weight: 400; letter-spacing: 0.02em; text-transform: none; color: var(--text-muted); margin-top: 8px; }
        
        .audio-toggle{ position: fixed; bottom: 24px; right: 24px; width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s var(--ease-smooth); z-index: 200; }
        .audio-toggle:hover{ border-color: var(--gold-dim); color: var(--gold); transform: scale(1.05); }
        .audio-toggle.active{ color: var(--gold); border-color: var(--gold-dim); background: rgba(212, 168, 85, 0.12); box-shadow: 0 0 20px rgba(212, 168, 85, 0.2); }
        .audio-toggle svg{ width: 22px; height: 22px;}

        /* Tela de Ora√ß√£o */
        #prayer-screen{ position: fixed; inset: 0; display: flex; flex-direction: row; background: var(--bg-deep); opacity: 0; visibility: hidden; transition: opacity 0.6s var(--ease-out), visibility 0.6s; z-index: 200; }
        #prayer-screen.active{ opacity: 1; visibility: visible; }
        .rosary-rail{ position: relative; width: var(--rail-width); height: 100%; background: linear-gradient(90deg, var(--bg-primary) 0%, var(--bg-deep) 100%); border-right: 1px solid rgba(212, 168, 85, 0.06); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .rosary-chain{ position: absolute; top: 50%; left: 50%; width: 3px; height: calc(100% + 300px); transform: translate(-50%, -50%); background: linear-gradient(180deg, transparent 0%, var(--gold-dark) 3%, var(--gold) 50%, var(--gold-dark) 97%, transparent 100%); opacity: 0.4; }
        .center-guide{ position: absolute; top: 50%; left: 15%; right: 15%; height: 1px; background: linear-gradient(90deg, transparent, rgba(212, 168, 85, 0.2), transparent); transform: translateY(-50%); z-index: 5; }
        #bead-track{ position: absolute; top: 50%; left: 50%; transform: translate(-50%, 0); display: flex; flex-direction: column; align-items: center; gap: var(--bead-gap); transition: transform 0.55s cubic-bezier(0.25, 0.46, 0.45, 0.94); padding: 100px 0; }
        
        .bead{ border-radius: 50%; cursor: pointer; transition: all 0.45s var(--ease-smooth); position: relative; flex-shrink: 0; }
        .bead.ave{ width: var(--bead-size-small); height: var(--bead-size-small); border: 2.5px solid var(--gold); }
        .bead.ave.active{ width: var(--bead-size); height: var(--bead-size); transform: scale(1.2); border-color: var(--gold-bright); box-shadow: 0 0 30px rgba(212, 168, 85, 0.8); }
        .bead.pater{ width: calc(var(--bead-size-small) + 14px); height: calc(var(--bead-size-small) + 14px); border: 3px solid var(--gold-bright); }
        .bead.pater.active{ width: var(--bead-size-pater); height: var(--bead-size-pater); transform: scale(1.2); border-width: 4px; box-shadow: 0 0 40px rgba(212, 168, 85, 1); }
        .bead.special{ width: calc(var(--bead-size-small) + 10px); height: calc(var(--bead-size-small) + 10px); border: 2.5px solid var(--gold); }
        .bead.special.active{ width: calc(var(--bead-size) + 10px); height: calc(var(--bead-size) + 10px); transform: scale(1.2); border-width: 3.5px; box-shadow: 0 0 35px rgba(212, 168, 85, 0.85); }
        .bead.rectangle-bead{ border-radius: 18px !important; width: calc(var(--bead-size-small) + 20px) !important; height: calc(var(--bead-size-small) - 4px) !important; }
        .bead.rectangle-bead.active{ width: calc(var(--bead-size) + 24px) !important; height: var(--bead-size) !important; border-radius: 20px !important; }

        .prayer-main{ flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .prayer-header{ padding: 18px 24px; background: linear-gradient(180deg, var(--bg-primary) 0%, transparent 100%); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .prayer-body{ flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 32px 32px; overflow-y: auto; }
        .prayer-group{ font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.28em; text-transform: uppercase; color: var(--gold-dim); margin-bottom: 8px; opacity: 0; transform: translateY(-10px); transition: all 0.45s; }
        .prayer-group.visible{ opacity: 1; transform: translateY(0); }
        .prayer-mystery{ font-family: var(--font-body); font-size: 1.2rem; font-style: italic; color: var(--text-secondary); margin-bottom: 18px; opacity: 0; transform: translateY(-10px); transition: all 0.45s 0.05s; }
        .prayer-mystery.visible{ opacity: 1; transform: translateY(0); }
        .prayer-name{ font-family: var(--font-display); font-size: 2.2rem; font-weight: 500; color: var(--text-primary); margin-bottom: 8px; opacity: 0; transform: translateY(-12px); transition: all 0.45s 0.1s; }
        .prayer-name.visible{ opacity: 1; transform: translateY(0); }
        .meditation-box{ background: linear-gradient(135deg, rgba(212, 168, 85, 0.1) 0%, rgba(212, 168, 85, 0.03) 100%); border-left: 3px solid var(--gold); padding: 20px 24px; margin-bottom: 24px; opacity: 0; transform: translateX(-15px); transition: all 0.5s 0.2s; }
        .meditation-box.visible{ opacity: 1; transform: translateX(0); }
        
        .prayer-text-toggle{ background: none; border: 1px solid var(--border-subtle); color: var(--text-muted); font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.14em; text-transform: uppercase; padding: 12px 18px; cursor: pointer; transition: all 0.35s; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-bottom: 14px; }
        
        /* CORRE√á√ÉO DO TEXTO */
        .prayer-full-text{ 
            max-height: 0; overflow: hidden; transition: max-height 0.45s ease-out, opacity 0.35s, padding 0.35s; 
            opacity: 0; background: var(--bg-card); border-radius: 6px; border: 1px solid var(--border-subtle); padding: 0 20px; 
        }
        .prayer-full-text.visible{ 
            max-height: 800px; opacity: 1; padding: 18px 20px; margin-bottom: 18px; overflow-y: auto; 
        }
        .prayer-full-text p{ font-family: var(--font-body); font-size: 1.15rem; color: var(--text-secondary); line-height: 1.85; margin: 0; }

        .prayer-footer{ padding: 18px 24px; background: linear-gradient(0deg, var(--bg-primary) 0%, transparent 100%); display: flex; align-items: center; justify-content: center; gap: 18px; flex-shrink: 0; }
        #completion-screen{ position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 28px; background: var(--bg-deep); z-index: 200; opacity: 0; visibility: hidden; transition: opacity 0.6s; }
        #completion-screen.active{ opacity: 1; visibility: visible; }

        @media (max-width: 768px){ 
            :root{ --rail-width: 85px; } 
            .rosary-rail{ order: 2; border-right: none; border-left: 1px solid rgba(212, 168, 85, 0.06); } 
            .prayer-main{ order: 1; }
        }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-container">
        <div class="auth-logo"></div>
        <h1 class="auth-title">Ros√°rio</h1>
        <p class="auth-subtitle">M√©todo de S√£o Lu√≠s de Montfort</p>
        <div class="auth-info">‚ú® <strong>Autentica√ß√£o Segura:</strong> Seus dados s√£o protegidos com Firebase!</div>
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login" type="button">Entrar</button>
            <button class="auth-tab" data-tab="register" type="button">Criar Conta</button>
        </div>
        <form id="login-form" class="auth-form active">
            <div class="input-group"><label class="input-label">Nome de Usu√°rio</label><input type="text" class="input-field" id="login-username" placeholder="Seu nome de usu√°rio" required autocomplete="username"></div>
            <div class="input-group"><label class="input-label">Senha</label><input type="password" class="input-field" id="login-password" placeholder="Sua senha" required autocomplete="current-password"></div>
            <button type="submit" class="auth-btn" id="login-btn">Entrar</button>
            <div class="auth-error" id="login-error"></div>
        </form>
        <form id="register-form" class="auth-form">
            <div class="input-group"><label class="input-label">Nome de Usu√°rio</label><input type="text" class="input-field" id="register-username" placeholder="Escolha um nome" required minlength="3" autocomplete="username"></div>
            <div class="input-group"><label class="input-label">Nome Completo</label><input type="text" class="input-field" id="register-displayname" placeholder="Seu nome completo" required minlength="2" autocomplete="name"></div>
            <div class="input-group"><label class="input-label">Crie uma Senha</label><input type="password" class="input-field" id="register-password" placeholder="M√≠nimo 6 caracteres" required minlength="6" autocomplete="new-password"></div>
            <div class="input-group"><label class="input-label">Confirme a Senha</label><input type="password" class="input-field" id="register-confirm" placeholder="Repita a senha" required autocomplete="new-password"></div>
            <button type="submit" class="auth-btn" id="register-btn">Criar Conta</button>
            <div class="auth-error" id="register-error"></div>
            <div class="auth-success" id="register-success"></div>
        </form>
    </div>
</div>

<div id="main-app" class="hidden">
    <div class="app-content">
        <div id="tab-home" class="tab-content active">
            <div class="home-screen-content">
                <div style="text-align: center; margin-bottom: 28px;">
                    <p style="font-family: var(--font-body); font-size: 1rem; color: var(--text-muted); margin-bottom: 4px;">Bem-vindo(a),</p>
                    <h2 style="font-family: var(--font-display); font-size: 1.4rem; color: var(--text-primary); letter-spacing: 0.1em;" id="home-user-name">Peregrino</h2>
                </div>
                <div style="width: 100%; max-width: 360px; margin: 0 auto 24px; background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 32px 24px; text-align: center; position: relative;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold-dim), var(--gold), var(--gold-dim));"></div>
                    <div style="font-family: var(--font-display); font-size: 3.5rem; font-weight: 600; color: var(--gold);" id="home-streak-count">0</div>
                    <div style="font-family: var(--font-display); font-size: 0.7rem; letter-spacing: 0.25em; text-transform: uppercase; color: var(--text-muted); margin-top: 8px;">Dias Consecutivos</div>
                    <p style="font-family: var(--font-body); font-size: 0.95rem; font-style: italic; color: var(--text-dim); margin-top: 12px;" id="home-streak-message">Comece hoje sua jornada de ora√ß√£o</p>
                </div>
                <div style="width: 100%; max-width: 360px; margin: 0 auto 24px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px;">
                    <span style="font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted);">Inten√ß√£o do Dia</span>
                    <p style="font-family: var(--font-body); font-size: 1.1rem; font-style: italic; color: var(--text-secondary); line-height: 1.6;" id="home-intention">Carregando...</p>
                </div>
                <div style="text-align: center;">
                    <p style="font-family: var(--font-display); font-size: 0.6rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-dim);" id="home-today-day">Segunda-feira</p>
                    <p style="font-family: var(--font-body); font-size: 1.1rem; color: var(--gold);" id="home-today-mystery">Mist√©rios</p>
                </div>
            </div>
        </div>

        <div id="tab-rosary" class="tab-content">
            <div style="padding: 24px 24px 100px 24px;">
                <h2 style="font-family: var(--font-display); font-size: 1.2rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); text-align: center; margin-bottom: 32px;">Escolha o Ros√°rio</h2>
                <div style="width: 100%; max-width: 360px; margin: 0 auto;">
                    <div style="display: flex; flex-direction: column; gap: 14px;">
                        <button class="btn-mystery" onclick="app.start('gozosos')" style="width: 100%;">Mist√©rios Gozosos</button>
                        <button class="btn-mystery" onclick="app.start('dolorosos')" style="width: 100%;">Mist√©rios Dolorosos</button>
                        <button class="btn-mystery" onclick="app.start('gloriosos')" style="width: 100%;">Mist√©rios Gloriosos</button>
                        <button class="btn-mystery btn-complete" onclick="app.start('completo')" style="width: 100%;">Ros√°rio Completo<small>Gozosos, Dolorosos e Gloriosos</small></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-calendar" class="tab-content">
            <div style="padding: 24px;">
                <h2 style="font-family: var(--font-display); font-size: 1.2rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); text-align: center; margin-bottom: 24px;">Calend√°rio</h2>
                <div style="width: 100%; max-width: 400px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: space-between;">
                    <button id="prev-month-btn" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">&lt;</button>
                    <h3 id="calendar-month-year" style="font-family:var(--font-display); color:var(--text-primary);">Data</h3>
                    <button id="next-month-btn" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">&gt;</button>
                </div>
                <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; max-width:400px; margin:0 auto;"></div>
            </div>
        </div>

        <div id="tab-friends" class="tab-content">
            <div style="padding: 24px 24px 100px 24px; min-height: 100%;">
                <div id="friends-main-view">
                    <h2 style="font-family: var(--font-display); font-size: 1.2rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); text-align: center; margin-bottom: 24px;">Amigos</h2>
                    <div style="width: 100%; max-width: 400px; margin: 0 auto 24px; display: flex; gap: 8px;">
                        <input type="text" id="friend-search-input" placeholder="@usuario" style="flex: 1; padding: 12px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);">
                        <button onclick="searchFriend()" style="padding: 12px; background: linear-gradient(135deg, var(--gold-dim) 0%, var(--gold) 100%); border: none; border-radius: 8px; color: var(--bg-deep); font-weight: bold;">BUSCAR</button>
                    </div>
                    <div id="search-result" style="width: 100%; max-width: 400px; margin: 0 auto 12px;"></div>
                    <div id="friend-requests-section" style="width: 100%; max-width: 400px; margin: 0 auto 24px; display: none;">
                        <h3 style="color: var(--text-muted); font-size: 0.8rem; margin-bottom:12px;">PEDIDOS RECEBIDOS</h3>
                        <div id="friend-requests-list"></div>
                    </div>
                    <div style="width: 100%; max-width: 400px; margin: 0 auto;">
                        <h3 style="color: var(--text-muted); font-size: 0.8rem; margin-bottom:12px;">MEUS AMIGOS</h3>
                        <div id="friends-list"></div>
                    </div>
                </div>
                <div id="friend-profile-view" style="display: none; animation: fadeIn 0.4s ease-out;">
                    <button onclick="backToFriendsList()" style="background: none; border: none; color: var(--text-muted); display: flex; align-items: center; gap: 8px; margin-bottom: 24px; cursor: pointer;">‚¨Ö VOLTAR</button>
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <div id="fp-avatar-container" style="width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--gold); overflow: hidden; margin-bottom: 16px; display: flex; align-items: center; justify-content: center;"></div>
                        <h2 id="fp-name" style="font-family: var(--font-display); font-size: 1.6rem; color: var(--text-primary); margin-bottom: 4px;"></h2>
                        <p id="fp-username" style="font-family: var(--font-body); font-size: 1rem; color: var(--gold); margin-bottom: 24px;"></p>
                        <div style="width: 100%; max-width: 360px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="background: rgba(212, 168, 85, 0.05); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 20px 16px; text-align: center;">
                                <div id="fp-streak" style="font-family: var(--font-display); font-size: 2.2rem; font-weight: 600; color: var(--gold);">0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">DIAS SEGUIDOS</div>
                            </div>
                            <div style="background: rgba(212, 168, 85, 0.05); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 20px 16px; text-align: center;">
                                <div id="fp-rosaries" style="font-family: var(--font-display); font-size: 2.2rem; font-weight: 600; color: var(--gold);">0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">ROS√ÅRIOS</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-profile" class="tab-content">
            <div style="padding: 24px; display: flex; flex-direction: column; align-items: center;">
                <div style="width: 80px; height: 80px; margin-bottom: 16px; cursor: pointer;" id="profile-avatar" onclick="openAvatarModal()"></div>
                <h2 id="profile-name" style="color: var(--text-primary); margin-bottom: 8px;">Usu√°rio</h2>
                <p style="color: var(--text-dim); font-size: 0.75rem; cursor: pointer;" onclick="openAvatarModal()">Clique para alterar avatar</p>
                
                <div style="width: 100%; max-width: 360px; margin: 24px 0; background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px; text-align: center;">
                    <div style="font-family: var(--font-display); font-size: 3.5rem; color: var(--gold);" id="profile-streak-count">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted);">DIAS CONSECUTIVOS</div>
                </div>
                
                <button onclick="firebaseAuth.logoutUser()" style="padding: 16px; background: rgba(180, 60, 60, 0.2); border: 1px solid rgba(180, 60, 60, 0.3); color: #c07070; width: 100%; max-width: 300px; border-radius: 8px;">SAIR DA CONTA</button>
            </div>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <button class="nav-item active" data-tab="home"><span class="nav-label">In√≠cio</span></button>
        <button class="nav-item" id="nav-rosary-btn" data-tab="rosary"><span class="nav-label">Ros√°rio</span></button>
        <button class="nav-item" data-tab="calendar"><span class="nav-label">Calend√°rio</span></button>
        <button class="nav-item" data-tab="friends"><span class="nav-label">Amigos</span></button>
        <button class="nav-item" data-tab="profile"><span class="nav-label">Perfil</span></button>
    </nav>
</div>

<div id="avatar-modal">
    <div class="avatar-modal-content">
        <button class="avatar-modal-close" onclick="closeAvatarModal()">√ó</button>
        <h2 class="avatar-modal-title">Escolha seu Avatar</h2>
        <div class="avatar-grid" id="avatar-grid"></div>
        <button class="avatar-save-btn" id="avatar-save-btn" onclick="saveAvatar()">Salvar Avatar</button>
    </div>
</div>

<div id="prayer-screen">
    <div class="rosary-rail"><div class="rosary-chain"></div><div class="center-guide"></div><div id="bead-track"></div></div>
    <div class="prayer-main">
        <header class="prayer-header">
            <button class="back-btn" onclick="app.confirmExit()">Sair</button>
            <div class="progress-compact"><div class="progress-bar-mini"><div class="progress-fill-mini" id="progress-fill"></div></div><span class="progress-text" id="progress-text">1/59</span></div>
        </header>
        <div class="prayer-body" id="prayer-body">
            <div class="prayer-group" id="prayer-group"></div>
            <div class="prayer-mystery" id="prayer-mystery"></div>
            <h2 class="prayer-name" id="prayer-name"></h2>
            <div class="prayer-count" id="prayer-count"></div>
            <div class="meditation-box" id="meditation-box">
                <div class="meditation-label">Medita√ß√£o</div>
                <p class="meditation-text" id="meditation-text"></p>
            </div>
            <button class="prayer-text-toggle" id="prayer-text-toggle" onclick="app.toggleText()">Ver texto da ora√ß√£o</button>
            <div class="prayer-full-text" id="prayer-full-text"></div>
        </div>
        <footer class="prayer-footer">
            <button class="nav-btn" id="prev-btn" onclick="app.prev()">&lt;</button>
            <button class="nav-btn primary" id="next-btn" onclick="app.next()">&gt;</button>
        </footer>
    </div>
</div>

<div id="completion-screen">
    <h2 class="completion-title">Deo Gratias</h2>
    <p class="completion-subtitle" id="completion-msg"></p>
    <div class="completion-stats">
        <div class="stat"><div class="stat-value" id="stat-aves">0</div><div class="stat-label">Ave Marias</div></div>
        <div class="stat"><div class="stat-value" id="stat-paters">0</div><div class="stat-label">Pai Nossos</div></div>
    </div>
    <button class="btn-home" onclick="app.home()">Voltar ao In√≠cio</button>
</div>

<button class="audio-toggle" id="audio-toggle" onclick="app.toggleAudio()" title="Ativar/Desativar sons (M)">
    <svg id="audio-icon-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="display:none;"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
    <svg id="audio-icon-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
</button>

<script type="module">
import { firebaseConfig } from './config.js';
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getDatabase, ref, set, get, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const database = getDatabase(firebaseApp);

window.firebaseRef = ref;
window.firebaseGet = get;
window.firebaseUpdate = update;
window.firebaseDatabase = database;

// Fun√ß√µes de Auth e Helpers
window.getAvatarHTML = function(val, size='100%') {
    if (!val) return 'üë§';
    if (val.indexOf('.') > -1) return `<img src="img/avatars/${val}" class="avatar-img" style="width:${size};height:${size}">`;
    return `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:2rem">${val}</div>`;
};

window.loginUser = async (email, pass) => {
    try { await signInWithEmailAndPassword(auth, email + '@rosario.app', pass); } 
    catch(e) { alert('Erro login: ' + e.message); }
};
window.registerUser = async (user, name, pass) => {
    try { 
        const cred = await createUserWithEmailAndPassword(auth, user + '@rosario.app', pass);
        await set(ref(database, 'users/' + cred.user.uid), { username: user, displayName: name, avatar: 'therese.png', createdAt: new Date().toISOString() });
        alert('Conta criada!');
    } catch(e) { alert('Erro registro: ' + e.message); }
};
window.logoutUser = async () => { if(confirm("Sair?")) await signOut(auth); };

onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        window.currentUser = user;
        const snap = await get(ref(database, 'users/' + user.uid));
        if (snap.exists()) {
            window.userProfile = snap.val();
            window.updateUserInterface();
            if(window.loadFriends) window.loadFriends();
        }
    } else {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
        window.currentUser = null;
        window.userProfile = null;
    }
});
</script>

<script>
// --- TEXTOS E MEDITA√á√ïES (COMPLETOS) ---
const TEXTS = {
    cross: `Em nome do Pai, e do Filho, e do Esp√≠rito Santo. Am√©m.`,
    credo: `Creio em Deus Pai todo-poderoso, Criador do C√©u e da terra; e em Jesus Cristo, seu √∫nico Filho, Nosso Senhor, que foi concebido pelo poder do Esp√≠rito Santo; nasceu da Virgem Maria; padeceu sob P√¥ncio Pilatos, foi crucificado, morto e sepultado; desceu √† mans√£o dos mortos; ressuscitou ao terceiro dia; subiu aos C√©us; est√° sentado √† direita de Deus Pai todo-poderoso, de onde h√° de vir a julgar os vivos e os mortos. Creio no Esp√≠rito Santo; na Santa Igreja Cat√≥lica; na comunh√£o dos Santos; na remiss√£o dos pecados; na ressurrei√ß√£o da carne; na vida eterna. Am√©m.`,
    pater: `Pai nosso que estais nos C√©us, santificado seja o vosso Nome, venha a n√≥s o vosso Reino, seja feita a vossa vontade assim na terra como no C√©u. O p√£o nosso de cada dia nos dai hoje, perdoai-nos as nossas ofensas assim como n√≥s perdoamos a quem nos tem ofendido, e n√£o nos deixeis cair em tenta√ß√£o, mas livrai-nos do Mal. Am√©m.`,
    ave: `Ave Maria, cheia de gra√ßa, o Senhor √© convosco, bendita sois v√≥s entre as mulheres e bendito √© o fruto do vosso ventre, Jesus. Santa Maria, M√£e de Deus, rogai por n√≥s pecadores, agora e na hora da nossa morte. Am√©m.`,
    gloria: `Gl√≥ria ao Pai, e ao Filho, e ao Esp√≠rito Santo. Assim como era no princ√≠pio, agora e sempre, e por todos os s√©culos dos s√©culos. Am√©m.`,
    fatima: `√ì meu Jesus, perdoai-nos, livrai-nos do fogo do inferno, levai as almas todas para o C√©u, principalmente as que mais precisarem da vossa Miseric√≥rdia.`,
    salve: `Salve Rainha, M√£e de Miseric√≥rdia, vida, do√ßura e esperan√ßa nossa, salve! A v√≥s bradamos, os degredados filhos de Eva. A v√≥s suspiramos, gemendo e chorando neste vale de l√°grimas. Eia pois, advogada nossa, esses vossos olhos misericordiosos a n√≥s volvei. E depois deste desterro, mostrai-nos Jesus, bendito fruto do vosso ventre. √ì clemente, √≥ piedosa, √≥ doce sempre Virgem Maria. Rogai por n√≥s, Santa M√£e de Deus, para que sejamos dignos das promessas de Cristo. Am√©m.`
};

const MONTFORT = {
    intro: ["Em honra do Pai Eterno, que gera seu Filho contemplando-Se.", "Em honra do Verbo Eterno, igual ao Pai, que com Ele produz o Esp√≠rito Santo.", "Em honra do Esp√≠rito Santo, que procede do Pai e do Filho por via de amor."],
    gozosos: { name: "Mist√©rios Gozosos", mysteries: [
        { title: "A Anuncia√ß√£o", pater: "A caridade de Deus, imensa.", aves: ["Para lamentar o desgra√ßado estado de Ad√£o.", "Os desejos dos patriarcas.", "Os desejos de Maria.", "A caridade do Pai.", "O amor do Filho.", "A embaixada do anjo.", "O temor de Maria.", "O consentimento de Maria.", "A cria√ß√£o da alma de Jesus.", "A adora√ß√£o dos anjos."] },
        { title: "A Visita√ß√£o", pater: "A majestade de Deus, ador√°vel.", aves: ["O gozo de Maria.", "O sacrif√≠cio de Jesus.", "As complac√™ncias de Jesus.", "A d√∫vida de S√£o Jos√©.", "A elei√ß√£o dos escolhidos.", "O fervor na visita.", "A santifica√ß√£o de Jo√£o.", "A gratid√£o no Magnificat.", "A caridade em servir.", "A m√∫tua depend√™ncia."] },
        { title: "O Nascimento", pater: "As riquezas de Deus, infinitas.", aves: ["Os desprezos em Bel√©m.", "A pobreza do est√°bulo.", "A alta contempla√ß√£o.", "A sa√≠da do Verbo.", "Adora√ß√µes dos anjos.", "Formosura da inf√¢ncia.", "Vinda dos pastores.", "A circuncis√£o.", "Imposi√ß√£o do nome.", "Adora√ß√£o dos magos."] },
        { title: "A Apresenta√ß√£o", pater: "A sabedoria de Deus, eterna.", aves: ["Obedi√™ncia √† Lei.", "Sacrif√≠cio de Jesus.", "Sacrif√≠cio de Maria.", "Gozo de Sime√£o.", "Resgate de Jesus.", "Matan√ßa dos inocentes.", "Fuga para o Egito.", "Estada no Egito.", "Volta para Nazar√©.", "Crescimento em gra√ßa."] },
        { title: "O Encontro", pater: "A santidade de Deus, incompreens√≠vel.", aves: ["Vida oculta.", "Perda e encontro.", "Jejum no deserto.", "Batismo.", "Prega√ß√£o.", "Milagres.", "Elei√ß√£o dos ap√≥stolos.", "Transfigura√ß√£o.", "Lava-p√©s.", "Eucaristia."] }
    ]},
    dolorosos: { name: "Mist√©rios Dolorosos", mysteries: [
        { title: "A Agonia", pater: "A felicidade de Deus.", aves: ["Retiros de Jesus.", "Ora√ß√µes fervorosas.", "Paci√™ncia com ap√≥stolos.", "T√©dio da alma.", "Suor de sangue.", "Consolo do anjo.", "Conformidade com o Pai.", "Trai√ß√£o e pris√£o.", "Valor no encontro.", "Abandono."] },
        { title: "A Flagela√ß√£o", pater: "A paci√™ncia de Deus.", aves: ["Cordas.", "Bofetada.", "Nega√ß√µes.", "Ignom√≠nias.", "Despojamento.", "Desprezos.", "Varas e a√ßoites.", "Coluna.", "Sangue.", "Queda."] },
        { title: "A Coroa√ß√£o", pater: "A formosura de Deus.", aves: ["Despojamento 3¬™ vez.", "Coroa de espinhos.", "Olhos vendados.", "Bofetadas.", "Andrajo.", "Cana.", "Pedra.", "Ultrajes.", "Sangue na cabe√ßa.", "Cabelos arrancados."] },
        { title: "A Cruz", pater: "A onipot√™ncia de Deus.", aves: ["Eis o Homem.", "Preferido a Barrab√°s.", "Falsos testemunhos.", "Condena√ß√£o.", "Amor √† Cruz.", "Trabalho ao carregar.", "Quedas.", "Encontro com Maria.", "V√©u de Ver√¥nica.", "L√°grimas."] },
        { title: "A Crucifica√ß√£o", pater: "A justi√ßa de Deus.", aves: ["Cinco chagas.", "Cora√ß√£o traspassado.", "Cravos e lan√ßa.", "Vergonha.", "Compaix√£o de Maria.", "Sete palavras.", "Desamparo.", "Afli√ß√£o do Universo.", "Morte.", "Descida e sepultamento."] }
    ]},
    gloriosos: { name: "Mist√©rios Gloriosos", mysteries: [
        { title: "A Ressurrei√ß√£o", pater: "A eternidade de Deus.", aves: ["Descida aos infernos.", "Gozo dos Santos Padres.", "Reuni√£o alma e corpo.", "Sa√≠da do sepulcro.", "Vit√≥rias.", "Dons gloriosos.", "Poder de Jesus.", "Apari√ß√µes a Maria.", "Conversa√ß√µes.", "Miss√£o dos ap√≥stolos."] },
        { title: "A Ascens√£o", pater: "A imensidade de Deus.", aves: ["Promessa do Esp√≠rito Santo.", "Reuni√£o no Monte.", "Ben√ß√£o final.", "Subida ao C√©u.", "Triunfo no C√©u.", "Abertura das portas.", "Assento √† direita.", "Poder de julgar.", "√öltima vinda.", "Justi√ßa final."] },
        { title: "Pentecostes", pater: "A provid√™ncia de Deus.", aves: ["Verdade do Esp√≠rito.", "Dom do Esp√≠rito.", "Estrondo.", "L√≠nguas de fogo.", "Gra√ßas a Maria.", "Conduta maravilhosa.", "Doze frutos.", "Sete dons.", "Dom da Sabedoria.", "Vit√≥ria sobre o mal."] },
        { title: "A Assun√ß√£o", pater: "A liberalidade de Deus.", aves: ["Predestina√ß√£o.", "Concei√ß√£o Imaculada.", "Natividade.", "Apresenta√ß√£o.", "Vida isenta de pecado.", "Virtudes.", "Virgindade fecunda.", "Maternidade divina.", "Morte de amor.", "Ressurrei√ß√£o e assun√ß√£o."] },
        { title: "A Coroa√ß√£o", pater: "A gl√≥ria de Deus.", aves: ["Tr√≠plice coroa.", "Gozo do C√©u.", "Rainha do C√©u.", "Tesoureira.", "Medianeira.", "Destruidora de heresias.", "Ref√∫gio.", "M√£e.", "Do√ßura dos justos.", "Asilo universal."] }
    ]}
};

// --- LOGIC ---
const AudioSystem = {
    ctx: null, enabled: false,
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); },
    playBead() { if (!this.enabled) return; this.init(); const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + 0.1); },
    playBell() { if (!this.enabled) return; this.init(); },
    playComplete() { if (!this.enabled) return; this.init(); },
    toggle() { this.enabled = !this.enabled; return this.enabled; }
};

const app = {
    state: { type: null, beads: [], index: 0, showText: false },
    els: {},
    init() {
        this.els = {
            prayer: document.getElementById('prayer-screen'),
            completion: document.getElementById('completion-screen'),
            track: document.getElementById('bead-track'),
            progressFill: document.getElementById('progress-fill'),
            progressText: document.getElementById('progress-text'),
            group: document.getElementById('prayer-group'),
            mystery: document.getElementById('prayer-mystery'),
            name: document.getElementById('prayer-name'),
            count: document.getElementById('prayer-count'),
            meditationBox: document.getElementById('meditation-box'),
            meditationText: document.getElementById('meditation-text'),
            textToggle: document.getElementById('prayer-text-toggle'),
            fullText: document.getElementById('prayer-full-text'),
            prevBtn: document.getElementById('prev-btn'),
            audioToggle: document.getElementById('audio-toggle'),
            audioIconOn: document.getElementById('audio-icon-on'),
            audioIconOff: document.getElementById('audio-icon-off')
        };
        this.setupGestures();
        this.setupKeyboard();
    },
    setupGestures() { /* Same gesture logic */ },
    setupKeyboard() {
        document.addEventListener('keydown', e => {
            if (!this.state.type) return;
            if (['ArrowDown', 'ArrowRight', ' '].includes(e.key)) { e.preventDefault(); this.next(); }
            if (['ArrowUp', 'ArrowLeft'].includes(e.key)) { e.preventDefault(); this.prev(); }
            if (e.key === 'Escape') this.confirmExit();
            if (e.key.toLowerCase() === 't') this.toggleText();
        });
    },
    generateBeads(type) {
        const beads = []; let id = 0;
        const add = (beadType, name, textKey, meditation = '', meta = {}) => { beads.push({ id: id++, beadType, name, textKey, meditation, ...meta }); };
        add('special', 'Sinal da Cruz', 'cross', 'F√© na presen√ßa de Deus.');
        add('special', 'Creio', 'credo', 'Professamos nossa f√©.');
        add('pater', 'Pai Nosso', 'pater', 'Unidade de um s√≥ Deus.');
        MONTFORT.intro.forEach((med, i) => { add('ave', 'Ave Maria', 'ave', med, { count: `${i + 1}¬™ Ave Maria` }); });
        add('special', 'Gl√≥ria', 'gloria', 'Gl√≥ria √† Trindade.');
        let groups = type === 'completo' ? [MONTFORT.gozosos, MONTFORT.dolorosos, MONTFORT.gloriosos] : [MONTFORT[type]];
        groups.forEach(group => {
            group.mysteries.forEach((mystery, mIdx) => {
                const mysteryNum = mIdx + 1;
                add('pater', 'Pai Nosso', 'pater', mystery.pater, { group: group.name, mystery: mystery.title, count: `${mysteryNum}¬∫ Mist√©rio` });
                mystery.aves.forEach((med, aIdx) => { add('ave', 'Ave Maria', 'ave', med, { group: group.name, mystery: mystery.title, count: `${mysteryNum}¬™ Dezena ¬∑ ${aIdx + 1}¬™ Ave Maria` }); });
                add('special', 'Gl√≥ria', 'gloria', '', { group: group.name, mystery: mystery.title });
                add('special', 'Ora√ß√£o de F√°tima', 'fatima', '', { group: group.name, mystery: mystery.title });
            });
        });
        add('special', 'Salve Rainha', 'salve', 'M√£e de Miseric√≥rdia.');
        return beads;
    },
    start(type) {
        this.state.type = type;
        this.state.beads = this.generateBeads(type);
        this.state.index = 0;
        this.state.showText = false;
        this.els.track.innerHTML = '';
        this.state.beads.forEach((bead, idx) => {
            const el = document.createElement('div');
            el.className = `bead ${bead.beadType}`;
            if (bead.beadType !== 'ave' && bead.beadType !== 'pater') el.classList.add('special');
            if (bead.textKey === 'gloria' || bead.textKey === 'fatima') el.classList.add('rectangle-bead');
            if (idx === 0) el.classList.add('active');
            el.onclick = () => this.goTo(idx);
            this.els.track.appendChild(el);
        });
        this.els.prayer.classList.add('active');
        this.update();
    },
    goTo(idx) { if (idx >= 0 && idx < this.state.beads.length) { this.state.index = idx; this.update(); AudioSystem.playBead(); } },
    next() { if (this.state.index < this.state.beads.length - 1) { this.state.index++; this.update(); AudioSystem.playBead(); } else { this.complete(); } },
    prev() { if (this.state.index > 0) { this.state.index--; this.update(); AudioSystem.playBead(); } },
    update() {
        const idx = this.state.index;
        const bead = this.state.beads[idx];
        const total = this.state.beads.length;
        const pct = ((idx + 1) / total) * 100;
        this.els.progressFill.style.width = `${pct}%`;
        this.els.progressText.textContent = `${idx + 1} / ${total}`;
        
        const animatedEls = [this.els.group, this.els.mystery, this.els.name, this.els.count, this.els.meditationBox];
        animatedEls.forEach(el => el.classList.remove('visible'));
        
        setTimeout(() => {
            this.els.group.textContent = bead.group || '';
            this.els.mystery.textContent = bead.mystery || '';
            this.els.name.textContent = bead.name;
            this.els.count.textContent = bead.count || '';
            this.els.meditationText.textContent = bead.meditation;
            
            // FIX: Ensure text is inserted
            this.els.fullText.innerHTML = `<p>${TEXTS[bead.textKey] || ''}</p>`;
            
            const isShortPrayer = bead.textKey === 'gloria' || bead.textKey === 'fatima';
            if (isShortPrayer) {
                this.els.fullText.classList.add('visible');
                this.els.textToggle.style.display = 'none';
            } else {
                this.els.textToggle.style.display = 'flex';
                if (this.state.showText) {
                    this.els.fullText.classList.add('visible');
                    this.els.textToggle.classList.add('expanded');
                } else {
                    this.els.fullText.classList.remove('visible');
                    this.els.textToggle.classList.remove('expanded');
                }
            }
            animatedEls.forEach(el => el.classList.add('visible'));
        }, 120);
        
        this.els.prevBtn.disabled = idx === 0;
        const beadEls = this.els.track.children;
        Array.from(beadEls).forEach(el => el.classList.remove('active'));
        beadEls[idx].classList.add('active');
        const activeEl = beadEls[idx];
        const beadCenter = activeEl.offsetTop + activeEl.offsetHeight / 2;
        this.els.track.style.transform = `translate(-50%, -${beadCenter}px)`;
    },
    toggleText() {
        this.state.showText = !this.state.showText;
        if (this.state.showText) {
            this.els.fullText.classList.add('visible');
            this.els.textToggle.classList.add('expanded');
        } else {
            this.els.fullText.classList.remove('visible');
            this.els.textToggle.classList.remove('expanded');
        }
    },
    confirmExit() { if (confirm('Sair?')) this.home(); },
    home() { this.state.type = null; this.els.prayer.classList.remove('active'); this.els.completion.classList.remove('active'); },
    complete() {
        AudioSystem.playComplete();
        const aves = this.state.beads.filter(b => b.beadType === 'ave').length;
        const paters = this.state.beads.filter(b => b.beadType === 'pater').length;
        document.getElementById('stat-aves').textContent = aves;
        document.getElementById('stat-paters').textContent = paters;
        document.getElementById('completion-msg').textContent = "Ros√°rio Completado";
        if (window.currentUser && window.userProfile) app.saveCompletion(aves, paters);
        this.els.prayer.classList.remove('active');
        this.els.completion.classList.add('active');
    },
    async saveCompletion(aves, paters) {
        try {
             const updates = {};
             const userId = window.currentUser.uid;
             const today = new Date();
             const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
             updates[`users/${userId}/prayedDays/${dateKey}`] = true;
             updates[`users/${userId}/totalRosaries`] = (window.userProfile.totalRosaries || 0) + 1;
             updates[`users/${userId}/totalAves`] = (window.userProfile.totalAves || 0) + aves;
             updates[`users/${userId}/totalPaters`] = (window.userProfile.totalPaters || 0) + paters;
             await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);
             window.userProfile.totalRosaries = (window.userProfile.totalRosaries || 0) + 1;
             window.updateUserInterface();
        } catch(e) { console.error(e); }
    }
};

window.updateUserInterface = function() {
    const p = window.userProfile;
    if (!p) return;
    document.getElementById('home-user-name').textContent = p.displayName;
    document.getElementById('profile-name').textContent = p.displayName;
    document.getElementById('profile-avatar').innerHTML = window.getAvatarHTML(p.avatar);
    document.getElementById('home-streak-count').textContent = p.currentStreak || 0;
    document.getElementById('profile-streak-count').textContent = p.currentStreak || 0;
    document.getElementById('profile-total-rosaries').textContent = p.totalRosaries || 0;
    document.getElementById('profile-longest-streak').textContent = p.longestStreak || 0;
    document.getElementById('profile-total-aves').textContent = p.totalAves || 0;
    document.getElementById('profile-total-paters').textContent = p.totalPaters || 0;
    renderCalendar();
};

const AVATARS = ['therese.png', 'pius.png', 'thomas.png', 'kolbe.jpg', 'madonna.png', 'agoustine.png', 'francis.jpg'];
let selectedAvatar = AVATARS[0];

window.openAvatarModal = function() {
    const grid = document.getElementById('avatar-grid');
    grid.innerHTML = '';
    AVATARS.forEach(f => {
        const div = document.createElement('div');
        div.className = 'avatar-option';
        if ((window.userProfile?.avatar || AVATARS[0]) === f) div.classList.add('selected');
        div.innerHTML = `<img src="img/avatars/${f}" class="avatar-img">`;
        div.onclick = () => {
            selectedAvatar = f;
            document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
            div.classList.add('selected');
        };
        grid.appendChild(div);
    });
    document.getElementById('avatar-modal').classList.add('active');
};
window.closeAvatarModal = () => document.getElementById('avatar-modal').classList.remove('active');

window.saveAvatar = async function() {
    const btn = document.getElementById('avatar-save-btn');
    btn.textContent = 'Salvando...';
    try {
        await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase, `users/${window.currentUser.uid}`), { avatar: selectedAvatar });
        window.userProfile.avatar = selectedAvatar;
        window.updateUserInterface();
        window.closeAvatarModal();
    } catch(e) { console.error(e); }
    btn.textContent = 'Salvar Avatar';
};

window.searchFriend = async function() {
    const term = document.getElementById('friend-search-input').value.trim().replace(/^@/, '').toLowerCase();
    const res = document.getElementById('search-result');
    res.innerHTML = 'Buscando...';
    try {
        const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'users'));
        let found = null, foundUid = null;
        snap.forEach(child => {
            const u = child.val();
            if (u.username.toLowerCase() === term) { found = u; foundUid = child.key; }
        });
        if (!found) { res.innerHTML = 'N√£o encontrado.'; return; }
        if (foundUid === window.currentUser.uid) { res.innerHTML = 'Voc√™ mesmo.'; return; }
        const friendSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, `users/${window.currentUser.uid}/friends/${foundUid}`));
        if (friendSnap.exists()) {
            res.innerHTML = `<div>${window.getAvatarHTML(found.avatar, '40px')} ${found.username} (J√° √© amigo)</div>`;
            return;
        }
        res.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; background:var(--bg-elevated); padding:10px; border-radius:8px;">
                ${window.getAvatarHTML(found.avatar, '40px')}
                <div style="flex:1">${found.displayName}<br><small>@${found.username}</small></div>
                <button onclick="sendRequest('${foundUid}')">Add</button>
            </div>`;
    } catch(e) { res.innerHTML = 'Erro.'; console.error(e); }
};

window.sendRequest = async function(uid) {
    const myUid = window.currentUser.uid;
    const updates = {};
    updates[`users/${myUid}/friendRequests/sent/${uid}`] = Date.now();
    updates[`users/${uid}/friendRequests/received/${myUid}`] = Date.now();
    await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);
    alert('Enviado!');
    document.getElementById('search-result').innerHTML = '';
};

window.loadFriends = async function() {
    const list = document.getElementById('friends-list');
    const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, `users/${window.currentUser.uid}/friends`));
    if (!snap.exists()) { list.innerHTML = '<p style="text-align:center;color:grey">Sem amigos ainda.</p>'; return; }
    list.innerHTML = '';
    const friends = snap.val();
    for (let uid in friends) {
        const uSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, `users/${uid}`));
        const u = uSnap.val();
        const div = document.createElement('div');
        div.style = "display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid var(--border-subtle); cursor:pointer;";
        div.innerHTML = `
            <div style="width:40px;height:40px;border-radius:50%;overflow:hidden;border:1px solid var(--gold)">${window.getAvatarHTML(u.avatar)}</div>
            <div><div style="font-weight:bold">${u.displayName}</div><div style="font-size:0.8rem;color:var(--text-muted)">@${u.username}</div></div>
        `;
        div.onclick = () => window.viewFriendProfile(uid, u);
        list.appendChild(div);
    }
};

window.viewFriendProfile = function(uid, user) {
    document.getElementById('friends-main-view').style.display = 'none';
    document.getElementById('friend-profile-view').style.display = 'block';
    document.getElementById('fp-avatar-container').innerHTML = window.getAvatarHTML(user.avatar);
    document.getElementById('fp-name').textContent = user.displayName;
    document.getElementById('fp-username').textContent = '@' + user.username;
    document.getElementById('fp-streak').textContent = user.currentStreak || 0;
    document.getElementById('fp-rosaries').textContent = user.totalRosaries || 0;
};

window.backToFriendsList = function() {
    document.getElementById('friend-profile-view').style.display = 'none';
    document.getElementById('friends-main-view').style.display = 'block';
};

window.loadFriendRequests = async function() {
    const list = document.getElementById('friend-requests-list');
    const sec = document.getElementById('friend-requests-section');
    const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, `users/${window.currentUser.uid}/friendRequests/received`));
    if (!snap.exists()) { sec.style.display = 'none'; return; }
    sec.style.display = 'block';
    list.innerHTML = '';
    const reqs = snap.val();
    for (let uid in reqs) {
        const uSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, `users/${uid}`));
        const u = uSnap.val();
        const div = document.createElement('div');
        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px">
                ${window.getAvatarHTML(u.avatar, '30px')} <span>${u.username}</span>
                <button onclick="acceptReq('${uid}')">V</button> <button onclick="rejectReq('${uid}')">X</button>
            </div>`;
        list.appendChild(div);
    }
};

window.acceptReq = async function(uid) {
    const myUid = window.currentUser.uid;
    const updates = {};
    updates[`users/${myUid}/friendRequests/received/${uid}`] = null;
    updates[`users/${uid}/friendRequests/sent/${myUid}`] = null;
    updates[`users/${myUid}/friends/${uid}`] = Date.now();
    updates[`users/${uid}/friends/${myUid}`] = Date.now();
    await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);
    window.loadFriendRequests(); window.loadFriends();
};

window.rejectReq = async function(uid) {
    const myUid = window.currentUser.uid;
    const updates = {};
    updates[`users/${myUid}/friendRequests/received/${uid}`] = null;
    updates[`users/${uid}/friendRequests/sent/${myUid}`] = null;
    await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);
    window.loadFriendRequests();
};

// Listeners
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '-form').classList.add('active');
        });
    });
    
    document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); loginUser(document.getElementById('login-username').value.trim(), document.getElementById('login-password').value); });
    document.getElementById('register-form').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        const pass = document.getElementById('register-password').value;
        if(pass !== document.getElementById('register-confirm').value) return alert('Senhas n√£o coincidem');
        registerUser(document.getElementById('register-username').value.trim(), document.getElementById('register-displayname').value.trim(), pass);
    });

    document.querySelectorAll('.nav-item[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            
            if (btn.dataset.tab === 'friends' && window.currentUser) {
                backToFriendsList();
                loadFriends();
                loadFriendRequests();
            }
        });
    });
    
    document.getElementById('nav-rosary-btn').addEventListener('click', () => document.querySelector('.nav-item[data-tab="rosary"]').click());
    
    document.getElementById('prev-month-btn').addEventListener('click', () => { currentCalendarMonth--; if(currentCalendarMonth < 0) { currentCalendarMonth=11; currentCalendarYear--;} renderCalendar(); });
    document.getElementById('next-month-btn').addEventListener('click', () => { currentCalendarMonth++; if(currentCalendarMonth > 11) { currentCalendarMonth=0; currentCalendarYear++;} renderCalendar(); });
    
    const searchIn = document.getElementById('friend-search-input');
    if(searchIn) searchIn.addEventListener('keypress', (e) => { if(e.key === 'Enter') searchFriend(); });
    
    app.init();
});
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch((err) => console.log('SW Fail:', err));
    });
  }
</script>
</body>
</html>
